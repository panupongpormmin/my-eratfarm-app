<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มหนู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">
    <div id="app-container" class="container mx-auto p-4 bg-white rounded-2xl shadow-2xl min-h-[90vh] flex flex-col items-center justify-center">
        <!-- สถานะโหลดเริ่มต้น -->
        <div class="text-gray-500 flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            กำลังเริ่มต้น...
        </div>
    </div>
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, where, getDocs, updateDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App ID ---
        const appId = 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAkCMLbcWCT9jhkRVU2bhVMjdWaeuMm1vo",
            authDomain: "eratfarm-bd035.firebaseapp.com",
            projectId: "eratfarm-bd035",
            storageBucket: "eratfarm-bd035.appspot.com",
            messagingSenderId: "462976136580",
            appId: "1:462976136580:web:a1ef8ee2b32f1cc4bf19d1",
            measurementId: "G-QHBHS05KRL"
        };
        
        // --- App State ---
        let app, db, auth;
        let currentUser = null, currentUserRole = null;
        let allRats = [], allOrders = [], allUsers = [], allDeaths = [], allTasks = [];
        let currentPage = 'main';
        let subPage = '';
        let fatteningSubPage = 'crate';
        let currentRack = '', currentShelf = '', currentSide = '', currentSize = '', currentWeight = '';
        let chartInstances = {};
        let unsubscribeListeners = [];
        const ratSizeOptions = [
            { size: "JUMP", minWeight: 9, maxWeight: 13 }, { size: "S", minWeight: 14, maxWeight: 18 },
            { size: "M", minWeight: 19, maxWeight: 23 }, { size: "L", minWeight: 24, maxWeight: 28 },
            { size: "XL", minWeight: 29, maxWeight: 33 }, { size: "XXL", minWeight: 34, maxWeight: 38 },
            { size: "XXL+", minWeight: 39, maxWeight: 45 }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    clearAllListeners();
                    if (user) {
                        currentUser = user;
                        await checkUserRole(user);
                        renderAppStructure();
                        attachDataListeners();
                    } else {
                        resetAppState();
                        renderLoginUI();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                renderError("การเริ่มต้น Firebase ล้มเหลว: " + error.message);
            }
        }

        // --- Data Management ---
        function attachDataListeners() {
            const paths = {
                rats: `artifacts/${appId}/public/data/rats`,
                orders: `artifacts/${appId}/public/data/orders`,
                users: `artifacts/${appId}/public/data/user_roles`,
                deaths: `artifacts/${appId}/public/data/deaths`,
                tasks: `artifacts/${appId}/public/data/tasks`,
            };
            const addListener = (path, stateUpdater, onError) => {
                unsubscribeListeners.push(onSnapshot(collection(db, path), 
                    (snapshot) => { stateUpdater(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); updateDataDrivenUI(); },
                    onError
                ));
            };
            addListener(paths.rats, (data) => allRats = data, (err) => console.error("Rats Listener Error:", err));
            addListener(paths.orders, (data) => allOrders = data, (err) => console.error("Orders Listener Error:", err));
            addListener(paths.deaths, (data) => allDeaths = data, (err) => console.error("Deaths Listener Error:", err));
            addListener(paths.tasks, (data) => allTasks = data, (err) => console.error("Tasks Listener Error:", err));
            
            if (currentUserRole === 'admin') {
                 addListener(paths.users, (data) => allUsers = data, (err) => console.error("Users Listener Error:", err));
            }
        }

        function clearAllListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        }

        function resetAppState() {
            currentUser = null; currentUserRole = null;
            allRats = []; allOrders = []; allUsers = []; allDeaths = []; allTasks = [];
            currentPage = 'main'; subPage = ''; fatteningSubPage = 'crate';
            currentRack = ''; currentShelf = ''; currentSide = ''; currentSize = ''; currentWeight = '';
        }

        async function checkUserRole(user) {
            const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, user.uid);
            try {
                const docSnap = await getDoc(userRoleRef);
                if (docSnap.exists()) {
                    currentUserRole = docSnap.data().role;
                } else {
                    const rolesQuery = query(collection(db, `artifacts/${appId}/public/data/user_roles`));
                    const rolesSnapshot = await getDocs(rolesQuery);
                    const newRole = rolesSnapshot.empty ? 'admin' : 'user';
                    await setDoc(userRoleRef, { role: newRole, email: user.email, name: user.displayName });
                    currentUserRole = newRole;
                }
                if ((['admin', 'ceo'].includes(currentUserRole)) && currentPage === 'main') {
                    currentPage = 'dashboard';
                }
            } catch (error) {
                console.error("Check Role Error:", error);
                renderError("ไม่สามารถตรวจสอบสิทธิ์ผู้ใช้ได้: " + error.message + "<br>กรุณาตรวจสอบ Firestore Security Rules");
            }
        }
        
        // --- Logic Functions ---
        async function saveTask(button) {
            const input = document.getElementById('new-task-input');
            const taskText = input.value.trim();
            if (!taskText) return alert("กรุณาป้อนข้อความงาน");
            
            button.disabled = true;
            const taskData = {
                text: taskText,
                status: 'pending',
                createdBy: currentUser.displayName,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), taskData);
                input.value = '';
            } catch (e) {
                console.error("Error saving task:", e);
            } finally {
                button.disabled = false;
            }
        }

        async function updateTaskStatus(taskId, newStatus) {
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), { status: newStatus });
            } catch (e) {
                console.error("Error updating task status:", e);
            }
        }
        
        async function deleteClosestRat(button) {
            const weightInput = document.getElementById('delete-rat-weight-input');
            const targetWeight = parseFloat(weightInput.value);

            if (!targetWeight || isNaN(targetWeight) || targetWeight <= 0) {
                return alert("กรุณากรอกน้ำหนักให้ถูกต้อง");
            }
            
            if (!currentRack || !currentShelf || !currentSide) {
                return alert("เกิดข้อผิดพลาด: ไม่พบตำแหน่งกระบะ");
            }

            button.disabled = true;
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/rats`), where("rack", "==", currentRack), where("shelf", "==", currentShelf), where("side", "==", currentSide));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { alert("ไม่พบหนูในกระบะที่เลือก"); return; }

                const candidates = querySnapshot.docs.map(d => {
                    const ratData = d.data();
                    const estimatedWeight = ratData.weight + ((new Date() - new Date(ratData.createdAt)) / 86400000 * 0.9);
                    return {id: d.id, ...ratData, estimatedWeight };
                });
                let closestRat = candidates.reduce((prev, curr) => (Math.abs(curr.estimatedWeight - targetWeight) < Math.abs(prev.estimatedWeight - targetWeight) ? curr : prev));
                
                if (confirm(`ระบบพบหนูที่มีน้ำหนักใกล้เคียงที่สุดคือ ${closestRat.estimatedWeight.toFixed(1)}g.\nคุณต้องการลบหนูตัวนี้ใช่หรือไม่?`)) {
                    const deathData = { ...closestRat, deathDate: serverTimestamp() };
                    delete deathData.estimatedWeight; // Don't save temporary field
                    await addDoc(collection(db, `artifacts/${appId}/public/data/deaths`), deathData);
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id));
                    alert(`บันทึกการตายและลบหนูเรียบร้อยแล้ว`);
                    document.getElementById('delete-rat-modal').classList.add('hidden');
                }
            } catch (e) {
                console.error("Error in delete process:", e);
            } finally { button.disabled = false; }
        }
        
        async function saveRat(button) {
            if (!currentRack || !currentShelf || !currentSide || !currentSize || !currentWeight) {
                return alert("กรุณากรอกข้อมูลให้ครบถ้วน");
            }
            button.disabled = true;
            const ratData = {
                rack: currentRack, shelf: currentShelf, side: currentSide,
                size: currentSize, weight: parseFloat(currentWeight),
                createdAt: new Date().toISOString()
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/rats`), ratData);
            } catch(e) { console.error(e); } finally { button.disabled = false; }
        }

        async function returnRatToCrate(button) {
            if (!currentRack || !currentShelf || !currentSide || !currentWeight) {
                return alert("กรุณาเลือกตำแหน่งและกรอกน้ำหนักหนูที่จะส่งคืน");
            }
            button.disabled = true;
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/rats`), 
                    where("rack", "==", currentRack), 
                    where("shelf", "==", currentShelf), 
                    where("side", "==", currentSide)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    alert("ไม่พบหนูในกระบะที่เลือก");
                    button.disabled = false;
                    return;
                }

                const now = new Date();
                const weightToUpdate = parseFloat(currentWeight);
                const candidates = querySnapshot.docs.map(doc => {
                    const rat = { id: doc.id, ...doc.data() };
                    const daysAgo = (now - new Date(rat.createdAt)) / (1000 * 60 * 60 * 24);
                    const estimatedWeight = rat.weight + (daysAgo * 0.9); // Growth rate 0.9g/day
                    return { ...rat, estimatedWeight };
                });

                let closestRat = candidates.reduce((prev, curr) => 
                    (Math.abs(curr.estimatedWeight - weightToUpdate) < Math.abs(prev.estimatedWeight - weightToUpdate) ? curr : prev)
                );
                
                await updateDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id), {
                    weight: weightToUpdate,
                    createdAt: new Date().toISOString() // Reset the 'age' of the rat
                });

                alert(`อัปเดตน้ำหนักหนู (น้ำหนักประมาณ ${closestRat.estimatedWeight.toFixed(1)}g) เป็น ${weightToUpdate}g เรียบร้อยแล้ว`);

            } catch (e) {
                console.error("Error returning rat to crate:", e);
                alert("เกิดข้อผิดพลาดในการอัปเดตข้อมูลหนู");
            } finally {
                button.disabled = false;
            }
        }

        async function saveOrder(button) {
             button.disabled = true;
             const orderName = document.getElementById('order-name-input').value || 'New Order';
             const items = [];
             document.querySelectorAll('#order-items-container .order-item-row').forEach(row => {
                 const size = row.querySelector('.size-select').value;
                 const quantity = parseInt(row.querySelector('.quantity-input').value, 10);
                 if (size && quantity > 0) {
                     items.push({ size, quantity, sent: 0, status: 'pending' });
                 }
             });
             if (items.length > 0) {
                 try {
                     await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), { name: orderName, items, createdAt: new Date().toISOString() });
                     document.getElementById('add-order-modal').classList.add('hidden');
                 } catch (e) { console.error(e); }
             }
             button.disabled = false;
        }

        async function deleteOrder(orderId) {
            if(confirm('คุณต้องการลบ Order นี้ใช่หรือไม่?')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId));
                } catch(e) { console.error(e); }
            }
        }

        async function updateUserRole(userId, newRole) {
             try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/user_roles`, userId), { role: newRole });
             } catch(e) { console.error(e); }
        }

        async function sendRatToOrder(button) {
            if (!currentRack || !currentShelf || !currentSide || !currentSize || !currentWeight) {
                return alert("กรุณากรอกข้อมูลหนูที่จะส่งให้ครบถ้วน");
            }

            let targetOrder = null;
            let targetItemIndex = -1;

            const sortedOrders = [...allOrders].sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
            for (const order of sortedOrders) {
                const index = (order.items || []).findIndex(item =>
                    item.size === currentSize && item.status === 'pending'
                );
                if (index !== -1) {
                    targetOrder = order;
                    targetItemIndex = index;
                    break;
                }
            }

            if (!targetOrder) {
                return alert(`ไม่พบ Order ที่ต้องการหนูไซส์ ${currentSize} หรือ Order ถูกปิดไปแล้ว`);
            }

            button.disabled = true;

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/rats`),
                    where("rack", "==", currentRack),
                    where("shelf", "==", currentShelf),
                    where("side", "==", currentSide)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    alert("ไม่พบหนูในกระบะที่เลือก");
                    button.disabled = false;
                    return;
                }

                const now = new Date();
                const weightToFind = parseFloat(currentWeight);
                const candidates = querySnapshot.docs.map(doc => {
                    const rat = { id: doc.id, ...doc.data() };
                    const daysAgo = (now - new Date(rat.createdAt)) / (1000 * 60 * 60 * 24);
                    const estimatedWeight = rat.weight + (daysAgo * 0.9);
                    return { ...rat, estimatedWeight };
                });
                let closestRat = candidates.reduce((prev, curr) => (Math.abs(curr.estimatedWeight - weightToFind) < Math.abs(prev.estimatedWeight - weightToFind) ? curr : prev));

                await deleteDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id));

                const updatedItems = [...targetOrder.items];
                updatedItems[targetItemIndex].sent = (updatedItems[targetItemIndex].sent || 0) + 1;
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, targetOrder.id), { items: updatedItems });

                alert(`ส่งหนู (น้ำหนักประมาณ ${closestRat.estimatedWeight.toFixed(1)}g) เข้า Order '${targetOrder.name}' เรียบร้อย`);
            } catch (e) {
                console.error("Error sending rat to order:", e);
                alert("เกิดข้อผิดพลาดในการส่ง Order");
            } finally {
                button.disabled = false;
            }
        }
        
        async function markOrderItemStatus(orderId, itemIndex, status) {
            if (!['admin', 'officer'].includes(currentUserRole)) return;
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const updatedItems = [...order.items];
            if (updatedItems[itemIndex]) {
                updatedItems[itemIndex].status = status;
            }

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId), { items: updatedItems });
            } catch (e) {
                console.error("Error updating order status:", e);
                alert("เกิดข้อผิดพลาดในการอัปเดตสถานะ");
            }
        }

        // --- Authentication ---
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("Sign In Error:", error); }
        }
        async function signOutUser() {
            try { await signOut(auth); } catch (error) { console.error("Sign Out Error:", error); }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.id || '';
                const classList = button.classList;
                const idParts = id.split('-');

                if (id === 'google-signin-btn') signInWithGoogle();
                else if (id === 'signout-btn') signOutUser();
                else if (id.startsWith('nav-')) {
                    currentPage = idParts[1];
                    subPage = (currentPage === 'department') ? 'fattening' : '';
                    renderPageContent();
                } else if (id.startsWith('sub-nav-')) {
                    const page = idParts[2];
                    const newSubPage = idParts[3];
                    if (page === 'department') {
                        subPage = newSubPage;
                        renderDepartmentPage();
                    } else if (page === 'fattening') {
                        fatteningSubPage = newSubPage;
                        renderFatteningContent();
                    }
                } 
                else if (id === 'save-rat-btn') saveRat(button);
                else if (id === 'send-rat-btn') sendRatToOrder(button);
                else if (id === 'return-rat-btn') returnRatToCrate(button);
                else if (id === 'open-delete-rat-modal-btn') {
                    if (!currentRack || !currentShelf || !currentSide) {
                        return alert("กรุณาเลือกตำแหน่งของกระบะก่อน");
                    }
                    document.getElementById('delete-rat-location').textContent = `${currentRack} / ชั้น ${currentShelf} / ${currentSide}`;
                    document.getElementById('delete-rat-modal').classList.remove('hidden');
                }
                else if (id === 'confirm-delete-rat-btn') deleteClosestRat(button);
                else if (id === 'save-task-btn') saveTask(button);
                else if (classList.contains('mark-task-complete-btn')) updateTaskStatus(button.dataset.taskId, 'completed');
                else if (id === 'open-add-order-modal') document.getElementById('add-order-modal').classList.remove('hidden');
                else if (id === 'add-order-item-btn') addNewOrderItemRow();
                else if (classList.contains('remove-item-btn')) button.closest('.order-item-row').remove();
                else if (id === 'save-order-btn') saveOrder(button);
                else if (classList.contains('close-modal-btn')) button.closest('.modal').classList.add('hidden');
                else if (classList.contains('delete-order-btn')) deleteOrder(button.dataset.orderId);
                else if (classList.contains('mark-order-success')) markOrderItemStatus(button.dataset.orderId, button.dataset.itemIndex, 'completed');
                else if (classList.contains('mark-order-fail')) markOrderItemStatus(button.dataset.orderId, button.dataset.itemIndex, 'incomplete');
            });
            document.body.addEventListener('change', (e) => {
                const target = e.target;
                if (['rat-rack', 'rat-shelf', 'rat-side'].includes(target.id)) {
                    currentRack = document.getElementById('rat-rack')?.value || '';
                    currentShelf = document.getElementById('rat-shelf')?.value || '';
                    currentSide = document.getElementById('rat-side')?.value || '';
                    if (currentPage === 'department') renderCrateSummary();
                } else if (target.name === 'rat-size') {
                    currentSize = target.value; currentWeight = '';
                    if (currentPage === 'department') document.getElementById('rat-form-container').innerHTML = renderRatForm();
                } else if (target.name === 'rat-weight') {
                    currentWeight = target.value;
                } else if (target.classList.contains('role-select')) {
                    updateUserRole(target.dataset.userId, target.value);
                }
            });
        }
        
        // --- UI Rendering ---
        function updateDataDrivenUI() {
            const pageRenderers = {
                'dashboard': renderDashboardPage, 'main': renderMainPage,
                'department': renderDepartmentPage, 'order': renderOrderPage, 
                'admin': renderAdminPage, 'analytics': renderAnalyticsPage, 'tasks': renderTasksPage
            };
            if (pageRenderers[currentPage]) {
                pageRenderers[currentPage]();
            } else {
                renderMainPage();
            }
        }

        function renderLoadingUI(message) {
            const container = document.getElementById('page-content');
            if(container) container.innerHTML = `<div class="text-gray-500 flex items-center justify-center p-8"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${message}</div>`;
        }

        function renderError(message) {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `<div class="text-red-500 text-center p-4 bg-red-50 rounded-lg"><h2 class="font-bold text-lg">เกิดข้อผิดพลาด</h2><p class="mt-2">${message}</p></div>`;
        }
        
        function renderLoginUI() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-md mx-auto text-center animate-fade-in">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ระบบจัดการฟาร์มหนู</h1>
                    <p class="text-gray-600 mb-6">กรุณาลงชื่อเข้าใช้เพื่อเริ่มต้น</p>
                    <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full hover:bg-blue-700 transition flex items-center justify-center">
                        <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691c-1.219 2.22-1.994 4.7-1.994 7.309s.775 5.089 1.994 7.309l-5.657 5.657C.654 30.65 0 27.464 0 24s.654-6.65 1.748-9.358z"/><path fill="#4CAF50" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657c-1.746 1.17-3.956 1.849-6.302 1.849-4.207 0-7.837-2.37-9.84-5.698l-5.657 5.657C9.043 43.125 15.93 48 24 48z"/><path fill="#1976D2" d="M43.611 20.083L43.595 20H24v8h11.303a12.042 12.042 0 01-4.087 5.571l5.657 5.657C40.071 35.731 44 30.34 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                        ลงชื่อเข้าใช้ด้วย Google
                    </button>
                </div>`;
        }
        
        function renderAppStructure() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="w-full max-w-5xl mx-auto animate-fade-in">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b">
                         <div class="flex items-center mb-4 sm:mb-0"><img src="${currentUser.photoURL}" alt="User" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">${currentUser.displayName}</p><p class="text-xs text-gray-500 uppercase font-bold">${currentUserRole}</p></div></div>
                         <button id="signout-btn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-600 transition">ออกจากระบบ</button>
                     </div>
                     <div id="nav-container" class="flex space-x-2 mb-6 justify-center flex-wrap gap-2"></div>
                     <div id="page-content" class="min-h-[400px]"></div>
                </div>`;
            document.getElementById('modal-container').innerHTML = renderAddOrderModal() + renderDeleteRatModal();
            renderPageContent();
        }

        function renderPageContent() {
             const pageContent = document.getElementById('page-content');
             const navContainer = document.getElementById('nav-container');
             if (!pageContent || !navContainer) return;

             const navButtons = [
                { id: 'dashboard', label: 'Dashboard', roles: ['admin', 'ceo'] },
                { id: 'main', label: 'หน้าหลัก', roles: ['admin', 'ceo', 'officer', 'fattening_staff', 'user'] },
                { id: 'department', label: 'แผนก', roles: ['admin', 'fattening_staff'] },
                { id: 'order', label: 'Order', roles: ['admin', 'officer'] },
                { id: 'analytics', label: 'Analytics', roles: ['admin', 'ceo'] },
                { id: 'tasks', label: 'แจ้งเตือน/งาน', roles: ['admin', 'ceo', 'officer', 'fattening_staff'] },
                { id: 'admin', label: 'Admin', roles: ['admin'] }
             ];

             navContainer.innerHTML = navButtons
                .filter(btn => btn.roles.includes(currentUserRole))
                .map(btn => `<button id="nav-${btn.id}" class="px-4 py-2 rounded-full font-semibold transition ${currentPage === btn.id ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">${btn.label}</button>`)
                .join('');
             
             renderLoadingUI('กำลังโหลดข้อมูล...');
             updateDataDrivenUI();
        }
        
        // --- PAGE RENDERERS ---
        function renderMainPage() { /* ... */ }
        function renderDashboardPage() { /* ... */ }
        function renderDepartmentPage() { /* ... */ }
        function renderFatteningContent() { /* ... */ }
        function renderFatteningSubContent() { /* ... */ }
        function renderBreedingDeptPage() { /* ... */ }
        function renderOrderPage() { /* ... */ }
        function renderActiveOrdersSummary() { /* ... */ }
        function renderAdminPage() { /* ... */ }
        function renderAnalyticsPage() { /* ... */ }
        function renderTasksPage() { /* ... */ }
        
        // --- UI Components ---
        function renderRatForm() {
            const rackOptions = [...Array(6).keys()].map(i => `<option value="Rack ${i + 1}" ${currentRack === `Rack ${i+1}` ? 'selected':''}>Rack ${i + 1}</option>`).join('');
            const shelfOptions = [...Array(6).keys()].map(i => `<option value="${i + 1}" ${currentShelf == (i+1) ? 'selected':''}>ชั้น ${i + 1}</option>`).join('');
            const sideOptions = ['ซ้าย', 'ขวา'].map(s => `<option value="${s}" ${currentSide === s ? 'selected':''}>${s}</option>`).join('');
            const sizeRadios = ratSizeOptions.map(opt => `<div><input type="radio" id="size-${opt.size}" name="rat-size" value="${opt.size}" class="hidden peer" ${currentSize === opt.size ? 'checked':''}><label for="size-${opt.size}" class="cursor-pointer block p-2 text-center border rounded peer-checked:bg-blue-500 peer-checked:text-white">${opt.size}</label></div>`).join('');
            const weightRadios = () => {
                const size = ratSizeOptions.find(s => s.size === currentSize);
                if (!size) return '';
                return [...Array(size.maxWeight - size.minWeight + 1).keys()].map(i => {
                    const w = size.minWeight + i;
                    return `<div><input type="radio" id="weight-${w}" name="rat-weight" value="${w}" class="hidden peer" ${currentWeight == w ? 'checked':''}><label for="weight-${w}" class="cursor-pointer block p-2 text-center border rounded peer-checked:bg-blue-500 peer-checked:text-white">${w}g</label></div>`;
                }).join('');
            };

            let actionButtonHtml = '';
            if (fatteningSubPage === 'crate') {
                actionButtonHtml = `<div class="space-y-2 pt-2">
                    <button id="save-rat-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition" type="button">+ เพิ่มหนู</button>
                    <button id="open-delete-rat-modal-btn" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition" type="button">ตาย</button>
                </div>`;
            } else if (fatteningSubPage === 'order') {
                actionButtonHtml = `<div class="space-y-2 pt-2">
                    <button id="send-rat-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition" type="button">ส่งหนูตาม Order</button>
                    <button id="return-rat-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" type="button">ส่งคืนเข้ากระบะ (อัปเดตน้ำหนัก)</button>
                </div>`;
            }

            return `<form class="bg-gray-50 p-4 rounded-lg space-y-4">
                <h2 class="text-xl font-bold">จัดการหนู</h2>
                <div><label class="block mb-1 font-semibold text-gray-700">Rack</label><select id="rat-rack" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${rackOptions}</select></div>
                <div><label class="block mb-1 font-semibold text-gray-700">ชั้น</label><select id="rat-shelf" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${shelfOptions}</select></div>
                <div><label class="block mb-1 font-semibold text-gray-700">กระบะ</label><select id="rat-side" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${sideOptions}</select></div>
                <div><label class="block mb-1 font-semibold text-gray-700">ไซส์</label><div class="grid grid-cols-4 gap-2">${sizeRadios}</div></div>
                <div class="${currentSize ? '' : 'hidden'}"><label class="block mb-1 font-semibold text-gray-700">น้ำหนัก</label><div class="grid grid-cols-5 gap-2">${weightRadios()}</div></div>
                ${actionButtonHtml}
            </form>`;
        }
        function renderCrateSummary() { /* ... */ }
        function renderAddOrderModal() { /* ... */ }
        function renderDeleteRatModal() { /* ... */ }
        function addNewOrderItemRow() { /* ... */ }
        
        // --- Chart & Metric Helpers ---
        function calculateDashboardMetrics() { /* ... */ }
        function createBarChart(canvasId, labels, data) { /* ... */ }
        function createDoughnutChart(canvasId, labels, data) { /* ... */ }
        
    </script>
</body>
</html>

