<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มหนู (แก้ไข appId)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">
    <div id="app-container" class="container mx-auto p-4 bg-white rounded-2xl shadow-2xl min-h-[90vh] flex flex-col items-center justify-center"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, getDocs, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ขั้นตอนสำคัญ! ---
        // 1. ไปที่ Firebase Console -> Firestore Database
        // 2. ดูใต้ collection 'artifacts' จะมี ID ของแอปคุณอยู่
        // 3. คัดลอก ID นั้นมาวางแทนที่ 'YOUR_APP_ID_HERE' ด้านล่างนี้
        const appId = 'c_0e6b1ab597f0efa8_index.html-109'; // <--- วาง appId ที่ถูกต้องจาก Firestore ของคุณที่นี่

        const firebaseConfig = {
            apiKey: "AIzaSyAkCMLbcWCT9jhkRVU2bhVMjdWaeuMm1vo",
            authDomain: "eratfarm-bd035.firebaseapp.com",
            projectId: "eratfarm-bd035",
            storageBucket: "eratfarm-bd035.appspot.com",
            messagingSenderId: "462976136580",
            appId: "1:462976136580:web:a1ef8ee2b32f1cc4bf19d1",
            measurementId: "G-QHBHS05KRL"
        };
        
        // --- App State ---
        let app, db, auth;
        let currentUser = null, currentUserRole = null;
        let allRats = [], allOrders = [];
        let currentPage = 'main';
        let unsubscribeListeners = [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderLoadingUI('กำลังเริ่มต้น...');
            initializeFirebase();
            setupEventListeners();
        });

        async function initializeFirebase() {
             if (appId === 'YOUR_APP_ID_HERE' || !appId) {
                return renderError("ยังไม่ได้กำหนดค่า 'appId' ในโค้ด. กรุณาแก้ไขไฟล์ index.html บรรทัดที่ 18");
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    clearAllListeners();
                    if (user) {
                        currentUser = user;
                        await checkUserRole(user);
                        renderAppStructure();
                        attachDataListeners();
                    } else {
                        resetAppState();
                        renderLoginUI();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                renderError("การเริ่มต้น Firebase ล้มเหลว");
            }
        }

        // --- Data Management ---
        function attachDataListeners() {
            unsubscribeListeners.push(onSnapshot(collection(db, `artifacts/${appId}/public/data/rats`), 
                (snapshot) => { 
                    allRats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                    updateDataDrivenUI(); 
                },
                (err) => console.error("Rats Listener Error:", err))
            );
            unsubscribeListeners.push(onSnapshot(collection(db, `artifacts/${appId}/public/data/orders`),
                (snapshot) => { 
                    allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                    updateDataDrivenUI(); 
                },
                (err) => console.error("Orders Listener Error:", err))
            );
        }

        function clearAllListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        }

        function resetAppState() {
            currentUser = null; currentUserRole = null;
            allRats = []; allOrders = [];
            currentPage = 'main';
        }

        async function checkUserRole(user) {
            const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, user.uid);
            try {
                const docSnap = await getDoc(userRoleRef);
                if (docSnap.exists()) {
                    currentUserRole = docSnap.data().role;
                } else {
                    const rolesQuery = query(collection(db, `artifacts/${appId}/public/data/user_roles`));
                    const rolesSnapshot = await getDocs(rolesQuery);
                    const newRole = rolesSnapshot.empty ? 'admin' : 'user';
                    await setDoc(userRoleRef, { role: newRole, email: user.email, name: user.displayName });
                    currentUserRole = newRole;
                }
                if ((['admin', 'ceo'].includes(currentUserRole)) && currentPage === 'main') {
                    currentPage = 'dashboard';
                }
            } catch (error) {
                console.error("Check Role Error:", error);
                renderError("ไม่สามารถตรวจสอบสิทธิ์ผู้ใช้ได้ กรุณาตรวจสอบ Firestore Security Rules");
            }
        }
        
        // --- Authentication ---
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("Sign In Error:", error); }
        }
        async function signOutUser() {
            try { await signOut(auth); } catch (error) { console.error("Sign Out Error:", error); }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.id || '';

                if (id === 'google-signin-btn') signInWithGoogle();
                else if (id === 'signout-btn') signOutUser();
                else if (id.startsWith('nav-')) {
                    currentPage = id.split('-')[1];
                    renderPageContent();
                }
            });
        }
        
        // --- UI Rendering ---
        function updateDataDrivenUI() {
            const pageRenderers = {
                'dashboard': renderDashboardPage, 'main': renderMainPage,
                'manage': renderManagePage, 'order': renderOrderPage, 'admin': renderAdminPage
            };
            if (pageRenderers[currentPage]) pageRenderers[currentPage]();
        }

        function renderLoadingUI(message) {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `<div class="text-gray-500">${message}</div>`;
        }

        function renderError(message) {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `<div class="text-red-500 text-center p-4"><h2 class="font-bold">เกิดข้อผิดพลาด</h2><p>${message}</p></div>`;
        }
        
        function renderLoginUI() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="p-4 bg-white rounded-xl shadow-lg w-full max-w-md mx-auto text-center animate-fade-in">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ระบบจัดการฟาร์มหนู</h1>
                    <p class="text-gray-600 mb-6">กรุณาลงชื่อเข้าใช้</p>
                    <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full">ลงชื่อเข้าใช้ด้วย Google</button>
                </div>`;
        }
        
        function renderAppStructure() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="w-full max-w-4xl mx-auto">
                     <div class="flex justify-between items-center mb-4 pb-4 border-b">
                         <div class="flex items-center"><img src="${currentUser.photoURL}" alt="User" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">${currentUser.displayName}</p><p class="text-xs text-gray-500">${currentUserRole}</p></div></div>
                         <button id="signout-btn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold">ออกจากระบบ</button>
                     </div>
                     <div id="nav-container" class="flex space-x-2 mb-6 justify-center"></div>
                     <div id="page-content" class="min-h-[400px]"></div>
                </div>`;
            renderPageContent();
        }

        function renderPageContent() {
             const pageContent = document.getElementById('page-content');
             const navContainer = document.getElementById('nav-container');
             if (!pageContent || !navContainer) return;

             const navButtons = [
                { id: 'dashboard', label: 'Dashboard', roles: ['admin', 'ceo'] },
                { id: 'main', label: 'หน้าหลัก', roles: ['admin', 'ceo', 'officer', 'fattening_staff', 'user'] },
                { id: 'manage', label: 'แผนกขุน', roles: ['admin', 'fattening_staff'] },
                { id: 'order', label: 'Order', roles: ['admin', 'officer'] },
                { id: 'admin', label: 'Admin', roles: ['admin'] }
             ];

             navContainer.innerHTML = navButtons
                .filter(btn => btn.roles.includes(currentUserRole))
                .map(btn => `<button id="nav-${btn.id}" class="px-4 py-2 rounded-full font-semibold ${currentPage === btn.id ? 'bg-blue-500 text-white' : 'bg-gray-200'}">${btn.label}</button>`)
                .join('');
             
             renderLoadingUI('กำลังโหลดข้อมูล...');
             updateDataDrivenUI();
        }
        
        function renderMainPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            pageContent.innerHTML = `<div class="animate-fade-in space-y-4">
                <h1 class="text-2xl font-bold">หน้าหลัก</h1>
                <div class="p-4 bg-gray-100 rounded-lg">
                    <p class="text-lg">จำนวนหนูทั้งหมด: <span class="font-bold">${allRats.length}</span> ตัว</p>
                    <p class="text-lg">จำนวนออเดอร์ที่ใช้งาน: <span class="font-bold">${allOrders.filter(o => o.items.some(i => i.sent < i.quantity)).length}</span> รายการ</p>
                </div>
            </div>`;
        }

        function renderDashboardPage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div>Dashboard Content</div>`;
        }
        function renderManagePage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div>Manage Content</div>`;
        }
        function renderOrderPage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div>Order Content</div>`;
        }
        function renderAdminPage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div>Admin Content</div>`;
        }

    </script>
</body>
</html>



