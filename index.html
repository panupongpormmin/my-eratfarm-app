<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มหนู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, where, getDocs, updateDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ตั้งค่าการแสดงผล log ใน console เพื่อช่วยในการดีบัก
        setLogLevel('debug');

        // ตัวแปรส่วนกลางที่ได้รับมาจากสภาพแวดล้อม Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // ข้อมูลการตั้งค่า Firebase ที่ได้รับจากผู้ใช้
        const firebaseConfig = {
            apiKey: "AIzaSyAkCMLbcWCT9jhkRVU2bhVMjdWaeuMm1vo",
            authDomain: "eratfarm-bd035.firebaseapp.com",
            projectId: "eratfarm-bd035",
            storageBucket: "eratfarm-bd035.appspot.com",
            messagingSenderId: "462976136580",
            appId: "1:462976136580:web:a1ef8ee2b32f1cc4bf19d1",
            measurementId: "G-QHBHS05KRL"
        };
        
        let app, db, auth;
        let userId = null;
        let currentUser = null;
        let currentUserRole = null;
        let allUsers = [];
        let allMessages = [];
        let isAuthReady = false;
        let allRats = [];
        let allOrders = [];
        let currentPage = 'main';
        let currentRack = '';
        let currentShelf = '';
        let currentSide = '';
        let currentSize = '';
        let currentWeight = '';
        let godModeEnabled = false;
        let chartInstances = {};


        const ratSizeOptions = [
            { size: "JUMP", minWeight: 9, maxWeight: 13 },
            { size: "S", minWeight: 14, maxWeight: 18 },
            { size: "M", minWeight: 19, maxWeight: 23 },
            { size: "L", minWeight: 24, maxWeight: 28 },
            { size: "XL", minWeight: 29, maxWeight: 33 },
            { size: "XXL", minWeight: 34, maxWeight: 38 },
            { size: "XXL+", minWeight: 39, maxWeight: 45 }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            currentUser = user;
                            godModeEnabled = localStorage.getItem('godModeEnabled') === 'true';
                            await checkUserRole(user);
                            isAuthReady = true;
                            listenToRats();
                            listenToOrders();
                            if (['admin', 'fattening_staff'].includes(currentUserRole)) {
                                listenToMessages();
                            }
                            if (currentUserRole === 'admin') {
                                listenToUsers();
                            }
                        } else {
                            userId = null;
                            currentUser = null;
                            currentUserRole = null;
                            isAuthReady = false;
                            allRats = [];
                            allOrders = [];
                            allUsers = [];
                            allMessages = [];
                            currentPage = 'main';
                            renderApp();
                        }
                    });
                } else {
                    renderError("โปรดวางข้อมูล `firebaseConfig` จาก Firebase Console ของคุณลงในโค้ด");
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                renderError("การเริ่มต้น Firebase ล้มเหลว โปรดตรวจสอบการตั้งค่าและ Security Rules ของคุณ");
            }
        }

        async function checkUserRole(user) {
            const rolesCollectionRef = collection(db, `artifacts/${appId}/public/data/user_roles`);
            const userRoleRef = doc(rolesCollectionRef, user.uid);
            const docSnap = await getDoc(userRoleRef);

            if (docSnap.exists()) {
                currentUserRole = docSnap.data().role;
            } else {
                const q = query(rolesCollectionRef, where("role", "==", "admin"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    await setDoc(userRoleRef, { role: 'admin', email: user.email, name: user.displayName });
                    currentUserRole = 'admin';
                } else {
                    await setDoc(userRoleRef, { role: 'user', email: user.email, name: user.displayName });
                    currentUserRole = 'user';
                }
            }
            // Set default page based on role
            if (['admin', 'ceo'].includes(currentUserRole)) {
                currentPage = 'dashboard';
            } else {
                currentPage = 'main';
            }
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error signing in with Google:", error);
                alertMessage("การลงชื่อเข้าใช้ด้วย Google ล้มเหลว");
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                alertMessage("การออกจากระบบล้มเหลว");
            }
        }
        
        function listenToRats() {
            if (!isAuthReady || !db) return;
            const ratsCollectionRef = collection(db, `artifacts/${appId}/public/data/rats`);
            onSnapshot(ratsCollectionRef, (snapshot) => {
                allRats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            }, (error) => console.error("Error listening to rats:", error));
        }
        
        function listenToOrders() {
            if (!isAuthReady || !db) return;
            const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
            onSnapshot(ordersCollectionRef, (snapshot) => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            }, (error) => console.error("Error listening to orders:", error));
        }
        
        function listenToUsers() {
            if (currentUserRole !== 'admin') return;
            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/user_roles`);
            onSnapshot(usersCollectionRef, (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(currentPage === 'admin') renderApp();
            });
        }

        function listenToMessages() {
            const messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
            onSnapshot(messagesRef, (snapshot) => {
                allMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentPage === 'manage') renderApp();
            });
        }
        
        async function updateUserRole(targetUserId, newRole) {
            if (currentUserRole !== 'admin') return alertMessage("คุณไม่มีสิทธิ์ในการดำเนินการนี้");
            const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, targetUserId);
            try {
                await updateDoc(userRoleRef, { role: newRole });
                alertMessage("อัปเดตยศเรียบร้อยแล้ว");
            } catch (error) {
                console.error("Error updating user role:", error);
                alertMessage("เกิดข้อผิดพลาดในการอัปเดตยศ");
            }
        }
        
        async function deleteUserAccount(targetUserId) {
            if (currentUserRole !== 'admin') return alertMessage("คุณไม่มีสิทธิ์ในการดำเนินการนี้");
            try {
                const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, targetUserId);
                await deleteDoc(userRoleRef);
                alertMessage("ลบข้อมูลยศผู้ใช้สำเร็จ (หมายเหตุ: การลบบัญชีออกจากระบบ Authentication ต้องทำผ่าน Cloud Function)");
            } catch (error) {
                console.error("Error deleting user role:", error);
                alertMessage("เกิดข้อผิดพลาดในการลบข้อมูลยศ");
            }
        }

        function setupEventListeners() {
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.id || '';

                if (id === 'google-signin-btn') await signInWithGoogle();
                else if (id === 'signout-btn') await signOutUser();
                else if (id.startsWith('nav-')) {
                    currentPage = id.split('-')[1];
                    renderApp();
                } else if (id === 'save-rat-btn') { e.preventDefault(); await saveRat(); }
                else if (id === 'send-order-btn') { e.preventDefault(); await sendOrderFromManage(); }
                else if (id === 'delete-rat-btn') { e.preventDefault(); await deleteRat(); }
                else if (id === 'clear-crate-btn') { e.preventDefault(); await clearCrate(); }
                else if (id === 'god-mode-toggle') {
                    godModeEnabled = !godModeEnabled;
                    localStorage.setItem('godModeEnabled', godModeEnabled);
                    renderApp();
                } else if (id === 'open-add-order-modal') {
                    const modal = document.getElementById('add-order-modal');
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.querySelector('div').classList.add('scale-100', 'opacity-100'), 10);
                } else if (id === 'add-order-item-btn') addNewOrderItemRow();
                else if (target.classList.contains('remove-item-btn')) target.closest('.order-item-row').remove();
                else if (id === 'save-order-btn') { e.preventDefault(); await saveOrder(); }
                else if (id === 'save-sheet-url-btn') { saveSheetUrl(); }
                else if (id === 'sync-sheet-btn') { await syncToGoogleSheets(); }
                else if (id.startsWith('close-modal-btn')) {
                    const modal = target.closest('.modal');
                    if (modal) {
                         const modalContent = modal.querySelector('div');
                        modalContent.classList.remove('scale-100', 'opacity-100');
                        modalContent.addEventListener('transitionend', () => {
                            modal.classList.add('hidden');
                            if(modal.id === 'add-order-modal') {
                                document.getElementById('add-order-form').reset();
                                document.getElementById('order-items-container').innerHTML = '';
                            }
                        }, { once: true });
                    }
                } else if (target.classList.contains('delete-order-btn')) { e.preventDefault(); await deleteOrder(target.dataset.orderId); }
                else if (id === 'calculate-days-btn') { e.preventDefault(); calculateDaysForTarget(); }
                else if (id === 'search-rats-btn') { e.preventDefault(); searchRatsForTarget(); }
                else if (target.classList.contains('mark-order-success')) { e.preventDefault(); await markOrderItemStatus(target.dataset.orderId, target.dataset.itemIndex, 'completed'); }
                else if (target.classList.contains('mark-order-fail')) { e.preventDefault(); openIncompleteModal(target.dataset.orderId, target.dataset.itemIndex); }
                else if (id === 'send-feedback-btn') { e.preventDefault(); await sendIncompleteFeedback(); }
                else if (target.classList.contains('mark-message-read')) { e.preventDefault(); await markMessageAsRead(target.dataset.messageId); }
                else if (target.classList.contains('delete-user-btn')) { e.preventDefault(); await deleteUserAccount(target.dataset.userId); }
            });

            document.body.addEventListener('change', (e) => {
                const target = e.target;
                if (['rat-rack', 'rat-shelf', 'rat-side'].includes(target.id)) {
                    currentRack = document.getElementById('rat-rack').value;
                    currentShelf = document.getElementById('rat-shelf').value;
                    currentSide = document.getElementById('rat-side').value;
                    handleFilterChange();
                } else if (target.name === 'rat-size') {
                    currentSize = target.value;
                    updateWeightOptions(currentSize);
                    renderApp();
                } else if (target.name === 'rat-weight') {
                    currentWeight = target.value;
                    renderApp();
                } else if (target.classList.contains('role-select')) {
                    updateUserRole(target.dataset.userId, target.value);
                } else if(target.id === 'use-marked-toggle') {
                    useMarkedLocations = target.checked;
                    handleFilterChange();
                }
            });
        }
        
        async function deleteOrder(orderId) {
            if (!['admin', 'officer'].includes(currentUserRole)) return;
            if (!orderId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId));
                alertMessage("ลบ Order เรียบร้อยแล้ว!");
            } catch (error) {
                console.error("Error deleting order:", error);
                alertMessage("เกิดข้อผิดพลาดในการลบ Order");
            }
        }
        
        async function markMessageAsRead(messageId) {
            if(!['admin', 'fattening_staff'].includes(currentUserRole)) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/messages`, messageId));
                alertMessage("รับทราบข้อความ");
            } catch (error) {
                 console.error("Error deleting message:", error);
                 alertMessage("เกิดข้อผิดพลาด");
            }
        }

        function openIncompleteModal(orderId, itemIndex) {
            const modal = document.getElementById('incomplete-feedback-modal');
            modal.querySelector('#send-feedback-btn').dataset.orderId = orderId;
            modal.querySelector('#send-feedback-btn').dataset.itemIndex = itemIndex;
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('div').classList.add('scale-100', 'opacity-100'), 10);
        }

        async function sendIncompleteFeedback() {
            const btn = document.getElementById('send-feedback-btn');
            const orderId = btn.dataset.orderId;
            const itemIndex = btn.dataset.itemIndex;
            const message = document.getElementById('feedback-textarea').value;

            if (!message.trim()) {
                alertMessage("กรุณาใส่ข้อความ");
                return;
            }

            const order = allOrders.find(o => o.id === orderId);
            const item = order.items[itemIndex];
            
            const messageData = {
                message,
                type: 'incomplete',
                orderName: order.name,
                itemName: `ไซส์ ${item.size} (${item.type})`,
                fromName: currentUser.displayName,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), messageData);
                await markOrderItemStatus(orderId, itemIndex, 'incomplete');
                alertMessage("ส่งข้อความเรียบร้อย");
                document.getElementById('close-modal-btn-feedback').click();
                document.getElementById('feedback-textarea').value = '';
            } catch (error) {
                console.error("Error sending feedback:", error);
                alertMessage("เกิดข้อผิดพลาดในการส่งข้อความ");
            }
        }

        async function markOrderItemStatus(orderId, itemIndex, status) {
             if (!['admin', 'officer'].includes(currentUserRole)) return;
             const order = allOrders.find(o => o.id === orderId);
             if (!order) return;

             const updatedItems = [...order.items];
             updatedItems[itemIndex].status = status;
             
             try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId), { items: updatedItems });
                alertMessage(`อัปเดตสถานะ Order เป็น "${status}"`);
                
                if(status === 'completed'){
                    const item = order.items[itemIndex];
                    const messageData = {
                        message: `Order ถูกยืนยันว่าสำเร็จเรียบร้อย`,
                        type: 'completed',
                        orderName: order.name,
                        itemName: `ไซส์ ${item.size} (${item.type})`,
                        fromName: currentUser.displayName,
                        timestamp: serverTimestamp()
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), messageData);
                }

             } catch (error) {
                 console.error("Error updating order status:", error);
                 alertMessage("เกิดข้อผิดพลาด");
             }
        }

        async function saveRat() {
            if (!['admin', 'fattening_staff'].includes(currentUserRole)) return;
            if (!currentRack || !currentShelf || !currentSide || !currentSize) {
                alertMessage("กรุณากรอกข้อมูลตำแหน่งและไซส์ให้ครบถ้วน");
                return;
            }
            if (!currentWeight) {
                alertMessage("กรุณาเลือกน้ำหนักก่อนเพิ่มหนู");
                return;
            }

            const ratData = {
                rack: currentRack, shelf: currentShelf, side: currentSide,
                size: currentSize, weight: parseFloat(currentWeight),
                createdAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/rats`), ratData);
                alertMessage("เพิ่มหนูใหม่เรียบร้อยแล้ว!");
            } catch (error) {
                console.error("Error saving rat:", error);
                alertMessage("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
            }
        }
        
        async function deleteRat() {
            if (!['admin', 'fattening_staff'].includes(currentUserRole)) return;
            if (!currentRack || !currentShelf || !currentSide || !currentSize) {
                alertMessage("กรุณาเลือกตำแหน่งและไซส์ของหนูที่ต้องการลบ");
                return;
            }
            if (!currentWeight) {
                alertMessage("กรุณาเลือกน้ำหนักของหนูที่ต้องการลบ");
                return;
            }
            const weight = parseFloat(currentWeight);
            const crateRats = allRats.filter(rat => rat.rack === currentRack && rat.shelf == currentShelf && rat.side === currentSide);
            if (crateRats.length === 0) return alertMessage("ไม่พบหนูในกระบะที่เลือก");
            
            const candidates = crateRats.map(rat => {
                const createdAt = new Date(rat.createdAt);
                const daysAgo = (new Date() - createdAt) / (1000 * 60 * 60 * 24);
                const estimatedWeight = rat.weight + (daysAgo * 0.9);
                return { ...rat, estimatedWeight, createdAt };
            });

            let closestRat = candidates.reduce((prev, curr) => {
                const prevDiff = Math.abs(prev.estimatedWeight - weight);
                const currDiff = Math.abs(curr.estimatedWeight - weight);
                if (currDiff < prevDiff) return curr;
                if (currDiff === prevDiff && curr.createdAt < prev.createdAt) return curr;
                return prev;
            });
            
            if (!closestRat) return alertMessage("ไม่พบหนูที่มีน้ำหนักใกล้เคียงในกระบะ");

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id));
                alertMessage(`ลบหนู (น้ำหนักประมาณ ${closestRat.estimatedWeight.toFixed(1)}g) เรียบร้อยแล้ว!`);
            } catch(error) {
                console.error("Error deleting rat:", error);
                alertMessage("เกิดข้อผิดพลาดในการลบหนู");
            }
        }

        async function sendOrderFromManage() {
            if (!['admin', 'fattening_staff'].includes(currentUserRole)) return;
            if (!currentRack || !currentShelf || !currentSide || !currentSize || !currentWeight) {
                alertMessage("กรุณากรอกข้อมูลการส่งให้ครบถ้วน");
                return;
            }

            const hasActiveOrders = allOrders.some(order => 
                order.items.some(item => {
                    const limit = item.type === 'หนูเป็น' ? item.quantity + 3 : item.quantity + 10;
                    return item.sent < limit;
                })
            );

            if (!hasActiveOrders) {
                alertMessage("ออเดอร์ทั้งหมดสำเร็จแล้ว ไม่สามารถส่งเพิ่มได้จนกว่าจะมีออเดอร์ใหม่");
                return;
            }

            const weight = parseFloat(currentWeight);

            let allPotentialItems = [];
            allOrders.forEach(order => {
                order.items.forEach((item, index) => {
                    const limit = item.type === 'หนูเป็น' ? item.quantity + 3 : item.quantity + 10;
                    if (item.size === currentSize && item.sent < limit) {
                        allPotentialItems.push({ ...item, orderId: order.id, itemIndex: index, orderDate: new Date(order.createdAt) });
                    }
                });
            });

            if (allPotentialItems.length === 0) {
                alertMessage(`ไม่พบ Order ที่ต้องการหนูไซส์ ${currentSize} หรือ Order เต็มตามโควต้าแล้ว`);
                return;
            }

            const liveCandidates = allPotentialItems.filter(item => item.type === 'หนูเป็น');
            const frozenCandidates = allPotentialItems.filter(item => item.type === 'หนูแช่');
            
            let targetItemGroup = [];

            const liveWeightMatch = liveCandidates.find(item => weight >= (item.minWeightTarget || -Infinity) && weight <= (item.maxWeightTarget || Infinity));
            if (liveWeightMatch) targetItemGroup = liveCandidates;
            else {
                const frozenWeightMatch = frozenCandidates.find(item => weight >= (item.minWeightTarget || -Infinity) && weight <= (item.maxWeightTarget || Infinity));
                targetItemGroup = frozenWeightMatch ? frozenCandidates : allPotentialItems;
            }
            
            let targetItem = null;
            if (targetItemGroup.length > 0) {
                const sortedGroup = targetItemGroup.sort((a,b) => a.orderDate - b.orderDate);
                targetItem = sortedGroup.find(item => item.priority === 'main') || sortedGroup.find(item => item.priority === 'secondary') || sortedGroup[0];
            } else {
                const sortedAll = allPotentialItems.sort((a,b) => a.orderDate - b.orderDate);
                targetItem = sortedAll.find(item => item.priority === 'main') || sortedAll.find(item => item.priority === 'secondary') || sortedAll[0];
            }

            if (!targetItem) return alertMessage("ไม่สามารถหา Order ที่เหมาะสมได้");
            
            if(godModeEnabled){
                try {
                    const orderToUpdate = allOrders.find(o => o.id === targetItem.orderId);
                    const updatedItems = [...orderToUpdate.items];
                    updatedItems[targetItem.itemIndex].sent += 1;
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, targetItem.orderId), { items: updatedItems });
                    alertMessage(`ส่ง Order สำเร็จ (GOD Mode)`);
                } catch(error) {
                    console.error("Error fulfilling from manage (GOD Mode):", error);
                    alertMessage("เกิดข้อผิดพลาดในการส่ง Order (GOD Mode)");
                }
                return;
            }

            const crateRats = allRats.filter(rat => rat.rack === currentRack && rat.shelf == currentShelf && rat.side === currentSide);
            if (crateRats.length === 0) return alertMessage("ไม่พบหนูในกระบะที่เลือก (ปิด GOD Mode อยู่)");

            const candidates = crateRats.map(rat => {
                const createdAt = new Date(rat.createdAt);
                const daysAgo = (new Date() - createdAt) / (1000 * 60 * 60 * 24);
                const estimatedWeight = rat.weight + (daysAgo * 0.9);
                return { ...rat, estimatedWeight, createdAt };
            });
            
            const closestRat = candidates.reduce((prev, curr) => {
                const prevDiff = Math.abs(prev.estimatedWeight - weight);
                const currDiff = Math.abs(curr.estimatedWeight - weight);
                if (currDiff < prevDiff) return curr;
                if (currDiff === prevDiff && curr.createdAt < prev.createdAt) return curr;
                return prev;
            });

            if (!closestRat) return alertMessage("ไม่พบหนูที่มีน้ำหนักใกล้เคียงในกระบะ");

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id));
                const orderToUpdate = allOrders.find(o => o.id === targetItem.orderId);
                const updatedItems = [...orderToUpdate.items];
                updatedItems[targetItem.itemIndex].sent += 1;
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, targetItem.orderId), { items: updatedItems });
                alertMessage(`ส่งหนู 1 ตัวเข้า Order '${orderToUpdate.name}' เรียบร้อย!`);
            } catch(error) {
                console.error("Error fulfilling from manage:", error);
                alertMessage("เกิดข้อผิดพลาดในการส่ง Order");
            }
        }
        
        async function saveOrder() {
            if (!['admin', 'officer'].includes(currentUserRole)) return;
            const orderName = document.getElementById('order-name-input').value || 'New Order';
            const orderItems = [];
            const itemRows = document.querySelectorAll('#order-items-container .order-item-row');

            itemRows.forEach(row => {
                const size = row.querySelector('.size-select').value;
                const quantity = parseInt(row.querySelector('.quantity-input').value, 10);
                const type = row.querySelector('input[name^="type"]:checked')?.value;
                const priority = row.querySelector('input[name^="priority"]:checked')?.value;
                const minWeight = parseFloat(row.querySelector('.min-weight-input').value);
                const maxWeight = parseFloat(row.querySelector('.max-weight-input').value);

                if (size && quantity > 0 && type) {
                    orderItems.push({
                        size, quantity, type,
                        priority: priority || 'main',
                        minWeightTarget: isNaN(minWeight) ? null : minWeight,
                        maxWeightTarget: isNaN(maxWeight) ? null : maxWeight,
                        sent: 0, status: 'pending'
                    });
                }
            });

            if (orderItems.length === 0) return alertMessage("กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ");

            const orderData = { name: orderName, items: orderItems, createdAt: new Date().toISOString() };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), orderData);
                alertMessage("บันทึก Order เรียบร้อยแล้ว!");
                document.getElementById('close-modal-btn-order').click();
            } catch (error) {
                console.error("Error saving order:", error);
                alertMessage("เกิดข้อผิดพลาดในการบันทึก Order");
            }
        }
        
        function renderApp() {
            const appContainer = document.getElementById('app-container');
            if (!currentUser) {
                appContainer.innerHTML = `
                    <div class="p-4 bg-white rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">ระบบจัดการฟาร์มหนู</h1>
                        <p class="text-gray-600 mb-6">กรุณาลงชื่อเข้าใช้เพื่อเริ่มต้น</p>
                        <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 transition-colors flex items-center justify-center w-full">
                            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691c-1.219 2.22-1.994 4.7-1.994 7.309s.775 5.089 1.994 7.309l-5.657 5.657C.654 30.65 0 27.464 0 24s.654-6.65 1.748-9.358z"/><path fill="#4CAF50" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657c-1.746 1.17-3.956 1.849-6.302 1.849-4.207 0-7.837-2.37-9.84-5.698l-5.657 5.657C9.043 43.125 15.93 48 24 48z"/><path fill="#1976D2" d="M43.611 20.083L43.595 20H24v8h11.303a12.042 12.042 0 01-4.087 5.571l5.657 5.657C40.071 35.731 44 30.34 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                            ลงชื่อเข้าใช้ด้วย Google
                        </button>
                    </div>
                `;
                return;
            }

            // Destroy previous charts to prevent memory leaks
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            appContainer.innerHTML = `
                <div class="p-4 bg-white rounded-xl shadow-lg w-full max-w-4xl mx-auto">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b-2 border-gray-200 flex-wrap gap-4">
                         <div class="flex items-center">
                             <img src="${currentUser.photoURL || 'https://placehold.co/40x40'}" alt="User photo" class="w-10 h-10 rounded-full mr-3">
                             <div>
                                 <p class="font-semibold text-gray-800">${currentUser.displayName}</p>
                                 <p class="text-xs text-gray-500">${currentUser.email} (${currentUserRole})</p>
                             </div>
                         </div>
                         <button id="signout-btn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-600 text-sm">ออกจากระบบ</button>
                     </div>

                     <div class="flex space-x-2 mb-6 justify-center flex-wrap gap-2">
                         ${(['admin', 'ceo'].includes(currentUserRole)) ? `<button id="nav-dashboard" class="px-4 py-2 rounded-full font-semibold transition-colors duration-200 text-base ${currentPage === 'dashboard' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Dashboard</button>`:''}
                         <button id="nav-main" class="px-4 py-2 rounded-full font-semibold transition-colors duration-200 text-base ${currentPage === 'main' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">หน้าหลัก</button>
                         <button id="nav-manage" class="px-4 py-2 rounded-full font-semibold transition-colors duration-200 text-base ${currentPage === 'manage' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">จัดการ</button>
                         <button id="nav-order" class="px-4 py-2 rounded-full font-semibold transition-colors duration-200 text-base ${currentPage === 'order' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Order</button>
                         ${currentUserRole === 'admin' ? `<button id="nav-admin" class="px-4 py-2 rounded-full font-semibold transition-colors duration-200 text-base ${currentPage === 'admin' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Admin</button>` : ''}
                     </div>
                     <div id="page-content"></div>
                </div>
                ${renderAddOrderModal()}
                ${renderIncompleteFeedbackModal()}
            `;
            
            if (currentPage === 'dashboard' && ['admin', 'ceo'].includes(currentUserRole)) renderDashboardPage();
            else if (currentPage === 'main') renderMainPage();
            else if (currentPage === 'manage') renderManagePage();
            else if (currentPage === 'order') renderOrderPage();
            else if (currentPage === 'admin' && currentUserRole === 'admin') renderAdminPage();
            else renderMainPage(); // Fallback to main page
        }
        
        function renderDashboardPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;

            const metrics = calculateDashboardMetrics();

            // --- START: MODIFIED SECTION 1 ---
            // เปลี่ยนชื่อหัวข้อของกราฟ
            pageContent.innerHTML = `
                <div class="space-y-6 animate-fade-in">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-100 p-4 rounded-lg shadow-md"><h3 class="text-blue-800 font-bold text-sm">หนูทั้งหมด</h3><p class="text-3xl font-bold text-blue-900">${metrics.totalRats}</p></div>
                        <div class="bg-green-100 p-4 rounded-lg shadow-md"><h3 class="text-green-800 font-bold text-sm">Order ที่ใช้งาน</h3><p class="text-3xl font-bold text-green-900">${metrics.activeOrders}</p></div>
                        <div class="bg-yellow-100 p-4 rounded-lg shadow-md"><h3 class="text-yellow-800 font-bold text-sm">สินค้าที่ต้องส่ง</h3><p class="text-3xl font-bold text-yellow-900">${metrics.totalPendingItems}</p></div>
                        <div class="bg-purple-100 p-4 rounded-lg shadow-md"><h3 class="text-purple-800 font-bold text-sm">อายุเฉลี่ย (วัน)</h3><p class="text-3xl font-bold text-purple-900">${metrics.avgRatAge}</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold mb-2 text-center text-gray-700">จำนวนหนูตามไซส์ปัจจุบัน</h3><canvas id="inventory-chart"></canvas></div>
                        <div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold mb-2 text-center text-gray-700">สถานะการส่ง Order</h3><canvas id="fulfillment-chart"></canvas></div>
                        <div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold mb-2 text-center text-gray-700">การกระจายหนูใน Rack</h3><canvas id="rack-chart"></canvas></div>
                        <div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold mb-2 text-center text-gray-700">สรุปจำนวนหนูที่เข้า-ออกใน 7 วันล่าสุด</h3><canvas id="growth-chart"></canvas></div>
                    </div>

                     <div class="bg-white p-4 rounded-lg shadow-lg">
                        <h3 class="font-bold mb-2 text-gray-700">รายการ Order ที่ต้องการเร่งด่วน</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Order</th>
                                        <th scope="col" class="px-6 py-3">ไซส์</th>
                                        <th scope="col" class="px-6 py-3">ประเภท</th>
                                        <th scope="col" class="px-6 py-3">ที่ต้องส่งเพิ่ม</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${metrics.priorityItems.map(item => `
                                        <tr class="bg-white border-b hover:bg-gray-50">
                                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.orderName}</th>
                                            <td class="px-6 py-4">${item.size}</td>
                                            <td class="px-6 py-4">${item.type}</td>
                                            <td class="px-6 py-4 font-bold text-red-600">${item.remaining}</td>
                                        </tr>
                                    `).join('')}
                                     ${metrics.priorityItems.length === 0 ? '<tr><td colspan="4" class="text-center py-4">ไม่มีรายการที่ต้องการเร่งด่วน</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            // --- END: MODIFIED SECTION 1 ---

            // --- START: MODIFIED SECTION 3 ---
            // สร้างกราฟเส้น 2 เส้นแทนที่ของเดิม
            setTimeout(() => {
                const inventoryLabels = ratSizeOptions.map(s => s.size);
                const inventoryData = inventoryLabels.map(label => metrics.ratCountBySize[label] || 0);

                createBarChart('inventory-chart', inventoryLabels, inventoryData, 'จำนวนหนู');
                createDoughnutChart('fulfillment-chart', ['ส่งแล้ว', 'ยังไม่ส่ง'], [metrics.totalItemsSent, metrics.totalPendingItems]);
                createBarChart('rack-chart', Object.keys(metrics.ratCountByRack), Object.values(metrics.ratCountByRack), 'จำนวนหนู');
                
                // สร้างกราฟ 'growth-chart' แบบ 2 เส้น
                const growthCtx = document.getElementById('growth-chart');
                if (growthCtx) {
                    chartInstances['growth-chart'] = new Chart(growthCtx, {
                        type: 'line',
                        data: {
                            labels: metrics.dailyActivityData.labels,
                            datasets: [
                                {
                                    label: 'จำนวนหนูที่เพิ่ม',
                                    data: metrics.dailyActivityData.added,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'จำนวนหนูที่ลดลง',
                                    data: metrics.dailyActivityData.removed,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    fill: true,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            }, 100);
            // --- END: MODIFIED SECTION 3 ---
        }

        function calculateDashboardMetrics() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // --- Inventory Metrics ---
            const totalRats = allRats.length;
            let totalRatAgeDays = 0;
            const ratCountBySize = {};
            ratSizeOptions.forEach(s => ratCountBySize[s.size] = 0);
            
            const ratCountByRack = { "Rack 1": 0, "Rack 2": 0, "Rack 3": 0, "Rack 4": 0 };
            
            allRats.forEach(rat => {
                const createdAt = new Date(rat.createdAt);
                const daysAgo = (now - createdAt) / (1000 * 60 * 60 * 24);
                totalRatAgeDays += daysAgo;
                if(rat.rack && ratCountByRack.hasOwnProperty(rat.rack)) {
                    ratCountByRack[rat.rack]++;
                }

                const estimatedWeight = rat.weight + (daysAgo * 0.9);
                for (const sizeData of ratSizeOptions) {
                    if (estimatedWeight >= sizeData.minWeight && estimatedWeight <= sizeData.maxWeight) {
                        ratCountBySize[sizeData.size]++;
                        break;
                    }
                }
            });
            const avgRatAge = totalRats > 0 ? (totalRatAgeDays / totalRats).toFixed(1) : 0;
            
            // --- Order Metrics ---
            let totalPendingItems = 0;
            let totalItemsSent = 0;
            const priorityItems = [];
            
            const activeOrdersList = allOrders.filter(order => order.items.some(item => item.sent < item.quantity));
            const activeOrders = activeOrdersList.length;

            allOrders.forEach(order => {
                order.items.forEach(item => {
                    const remaining = item.quantity - item.sent;
                    if(remaining > 0) {
                        totalPendingItems += remaining;
                        priorityItems.push({
                            orderName: order.name,
                            createdAt: new Date(order.createdAt),
                            ...item,
                            remaining
                        });
                    }
                    totalItemsSent += item.sent;
                });
            });

            priorityItems.sort((a,b) => b.remaining - a.remaining || a.createdAt - b.createdAt);
            
            // --- START: MODIFIED SECTION 2 ---
            // เปลี่ยนชื่อ Growth Metrics เป็น Daily Activity Metrics
            // และเพิ่มการคำนวณข้อมูล 'หนูที่ลดลง' (removed)
            const dailyActivity = {};
            const dailyLabels = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const label = date.toLocaleDateString('th-TH', { weekday: 'short' });
                dailyLabels.push(label);
                dailyActivity[label] = { added: 0, removed: 0 };
            }

            // คำนวณข้อมูลหนูที่เพิ่ม (จากข้อมูลจริง)
            allRats.forEach(rat => {
                const createdAt = new Date(rat.createdAt);
                if (createdAt >= new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000)) {
                    const label = createdAt.toLocaleDateString('th-TH', { weekday: 'short' });
                    if (dailyActivity.hasOwnProperty(label)) {
                        dailyActivity[label].added++;
                    }
                }
            });

            // !! หมายเหตุ: ส่วนนี้เป็นการจำลองข้อมูล 'หนูที่ลดลง'
            // คุณต้องนำข้อมูลจริงที่บันทึกไว้มาใส่แทนส่วนนี้
            const simulatedRemovedData = {
                [dailyLabels[0]]: 2,  // 6 วันก่อน
                [dailyLabels[1]]: 5,  // 5 วันก่อน
                [dailyLabels[2]]: 1,  // 4 วันก่อน
                [dailyLabels[3]]: 8,  // 3 วันก่อน
                [dailyLabels[4]]: 4,  // 2 วันก่อน
                [dailyLabels[5]]: 12, // 1 วันก่อน
                [dailyLabels[6]]: 7   // วันนี้
            };
            Object.keys(simulatedRemovedData).forEach(label => {
                if(dailyActivity.hasOwnProperty(label)) {
                    dailyActivity[label].removed = simulatedRemovedData[label];
                }
            });
            // !! จบส่วนจำลองข้อมูล

            return {
                totalRats,
                activeOrders,
                totalPendingItems,
                avgRatAge,
                ratCountBySize,
                ratCountByRack,
                totalItemsSent,
                priorityItems: priorityItems.slice(0, 5),
                dailyActivityData: {
                    labels: dailyLabels,
                    added: Object.values(dailyActivity).map(d => d.added),
                    removed: Object.values(dailyActivity).map(d => d.removed)
                }
            };
            // --- END: MODIFIED SECTION 2 ---
        }

        // NEW GENERIC CHART CREATION FUNCTIONS
        function createBarChart(canvasId, labels, data, chartLabel) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createDoughnutChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                        borderColor: ['rgba(22, 163, 74, 1)', 'rgba(220, 38, 38, 1)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }

        function createLineChart(canvasId, labels, data, chartLabel) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data:
