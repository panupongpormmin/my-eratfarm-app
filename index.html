<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มหนู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">
    <div id="app-container" class="container mx-auto p-4 bg-white rounded-2xl shadow-2xl min-h-[90vh] flex flex-col items-center justify-center">
        <!-- สถานะโหลดเริ่มต้น -->
        <div class="text-gray-500 flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            กำลังเริ่มต้น...
        </div>
    </div>
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, where, getDocs, updateDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App ID ---
        const appId = 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAkCMLbcWCT9jhkRVU2bhVMjdWaeuMm1vo",
            authDomain: "eratfarm-bd035.firebaseapp.com",
            projectId: "eratfarm-bd035",
            storageBucket: "eratfarm-bd035.appspot.com",
            messagingSenderId: "462976136580",
            appId: "1:462976136580:web:a1ef8ee2b32f1cc4bf19d1",
            measurementId: "G-QHBHS05KRL"
        };
        
        // --- App State ---
        let app, db, auth;
        let currentUser = null, currentUserRole = null;
        let allRats = [], allOrders = [], allUsers = [], allDeaths = [], allTasks = [];
        let currentPage = 'main';
        let subPage = '';
        let fatteningSubPage = 'crate';
        let currentRack = '', currentShelf = '', currentSide = '', currentSize = '', currentWeight = '';
        let chartInstances = {};
        let unsubscribeListeners = [];
        const ratSizeOptions = [
            { size: "JUMP", minWeight: 9, maxWeight: 13 }, { size: "S", minWeight: 14, maxWeight: 18 },
            { size: "M", minWeight: 19, maxWeight: 23 }, { size: "L", minWeight: 24, maxWeight: 28 },
            { size: "XL", minWeight: 29, maxWeight: 33 }, { size: "XXL", minWeight: 34, maxWeight: 38 },
            { size: "XXL+", minWeight: 39, maxWeight: 45 }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    clearAllListeners();
                    if (user) {
                        currentUser = user;
                        await checkUserRole(user);
                        renderAppStructure();
                        attachDataListeners();
                    } else {
                        resetAppState();
                        renderLoginUI();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                renderError("การเริ่มต้น Firebase ล้มเหลว: " + error.message);
            }
        }

        // --- Data Management ---
        function attachDataListeners() {
            const paths = {
                rats: `artifacts/${appId}/public/data/rats`,
                orders: `artifacts/${appId}/public/data/orders`,
                users: `artifacts/${appId}/public/data/user_roles`,
                deaths: `artifacts/${appId}/public/data/deaths`,
                tasks: `artifacts/${appId}/public/data/tasks`,
            };
            const addListener = (path, stateUpdater, onError) => {
                unsubscribeListeners.push(onSnapshot(collection(db, path), 
                    (snapshot) => { stateUpdater(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); updateDataDrivenUI(); },
                    onError
                ));
            };
            addListener(paths.rats, (data) => allRats = data, (err) => console.error("Rats Listener Error:", err));
            addListener(paths.orders, (data) => allOrders = data, (err) => console.error("Orders Listener Error:", err));
            addListener(paths.deaths, (data) => allDeaths = data, (err) => console.error("Deaths Listener Error:", err));
            addListener(paths.tasks, (data) => allTasks = data, (err) => console.error("Tasks Listener Error:", err));
            
            if (currentUserRole === 'admin') {
                 addListener(paths.users, (data) => allUsers = data, (err) => console.error("Users Listener Error:", err));
            }
        }

        function clearAllListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        }

        function resetAppState() {
            currentUser = null; currentUserRole = null;
            allRats = []; allOrders = []; allUsers = []; allDeaths = []; allTasks = [];
            currentPage = 'main'; subPage = ''; fatteningSubPage = 'crate';
            currentRack = ''; currentShelf = ''; currentSide = ''; currentSize = ''; currentWeight = '';
        }

        async function checkUserRole(user) {
            const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, user.uid);
            try {
                const docSnap = await getDoc(userRoleRef);
                if (docSnap.exists()) {
                    currentUserRole = docSnap.data().role;
                } else {
                    const rolesQuery = query(collection(db, `artifacts/${appId}/public/data/user_roles`));
                    const rolesSnapshot = await getDocs(rolesQuery);
                    const newRole = rolesSnapshot.empty ? 'admin' : 'user';
                    await setDoc(userRoleRef, { role: newRole, email: user.email, name: user.displayName });
                    currentUserRole = newRole;
                }
                if ((['admin', 'ceo'].includes(currentUserRole)) && currentPage === 'main') {
                    currentPage = 'dashboard';
                }
            } catch (error) {
                console.error("Check Role Error:", error);
                renderError("ไม่สามารถตรวจสอบสิทธิ์ผู้ใช้ได้: " + error.message + "<br>กรุณาตรวจสอบ Firestore Security Rules");
            }
        }
        
        // --- Logic Functions ---
        async function saveTask(button) {
            const input = document.getElementById('new-task-input');
            const taskText = input.value.trim();
            if (!taskText) return alert("กรุณาป้อนข้อความงาน");
            
            button.disabled = true;
            const taskData = {
                text: taskText,
                status: 'pending',
                createdBy: currentUser.displayName,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), taskData);
                input.value = '';
            } catch (e) {
                console.error("Error saving task:", e);
            } finally {
                button.disabled = false;
            }
        }

        async function updateTaskStatus(taskId, newStatus) {
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), { status: newStatus });
            } catch (e) {
                console.error("Error updating task status:", e);
            }
        }
        
        async function deleteClosestRat(button) {
            // ... (rest of the logic)
            // Inside the "if (confirm(...))" block, before deleteDoc:
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/rats`), where("rack", "==", currentRack), where("shelf", "==", currentShelf), where("side", "==", currentSide));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { alert("ไม่พบหนูในกระบะที่เลือก"); return; }

                const candidates = querySnapshot.docs.map(d => ({id: d.id, ...d.data(), estimatedWeight: d.data().weight + ((new Date() - new Date(d.data().createdAt)) / 86400000 * 0.9) }));
                let closestRat = candidates.reduce((prev, curr) => (Math.abs(curr.estimatedWeight - parseFloat(document.getElementById('delete-rat-weight-input').value)) < Math.abs(prev.estimatedWeight - parseFloat(document.getElementById('delete-rat-weight-input').value)) ? curr : prev));
                
                if (confirm(`ระบบพบหนูที่มีน้ำหนักใกล้เคียงที่สุดคือ ${closestRat.estimatedWeight.toFixed(1)}g.\nคุณต้องการลบหนูตัวนี้ใช่หรือไม่?`)) {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/deaths`), { ...closestRat, deathDate: serverTimestamp() });
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id));
                    alert(`บันทึกการตายและลบหนูเรียบร้อยแล้ว`);
                    document.getElementById('delete-rat-modal').classList.add('hidden');
                }
            } catch (e) {
                console.error("Error in delete process:", e);
            } finally { button.disabled = false; }
        }
        
        // ... Other logic functions like saveRat, saveOrder, etc. remain the same ...
        async function saveRat(button) { /* ... */ }
        async function returnRatToCrate(button) { /* ... */ }
        async function saveOrder(button) { /* ... */ }
        async function deleteOrder(orderId) { /* ... */ }
        async function updateUserRole(userId, newRole) { /* ... */ }
        async function sendRatToOrder(button) { /* ... */ }
        async function markOrderItemStatus(orderId, itemIndex, status) { /* ... */ }
        async function signInWithGoogle() { /* ... */ }
        async function signOutUser() { /* ... */ }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.id || '';
                const classList = button.classList;
                const idParts = id.split('-');

                if (id === 'google-signin-btn') signInWithGoogle();
                else if (id === 'signout-btn') signOutUser();
                else if (id.startsWith('nav-')) {
                    currentPage = idParts[1];
                    subPage = (currentPage === 'department') ? 'fattening' : '';
                    renderPageContent();
                } else if (id.startsWith('sub-nav-')) {
                    const page = idParts[2];
                    const newSubPage = idParts[3];
                    if (page === 'department') {
                        subPage = newSubPage;
                        renderDepartmentPage();
                    } else if (page === 'fattening') {
                        fatteningSubPage = newSubPage;
                        renderFatteningContent();
                    }
                } 
                else if (id === 'save-rat-btn') saveRat(button);
                else if (id === 'send-rat-btn') sendRatToOrder(button);
                else if (id === 'return-rat-btn') returnRatToCrate(button);
                else if (id === 'open-delete-rat-modal-btn') {
                    if (!currentRack || !currentShelf || !currentSide) {
                        return alert("กรุณาเลือกตำแหน่งของกระบะก่อน");
                    }
                    document.getElementById('delete-rat-location').textContent = `${currentRack} / ชั้น ${currentShelf} / ${currentSide}`;
                    document.getElementById('delete-rat-modal').classList.remove('hidden');
                }
                else if (id === 'confirm-delete-rat-btn') deleteClosestRat(button);
                else if (id === 'save-task-btn') saveTask(button);
                else if (classList.contains('mark-task-complete-btn')) updateTaskStatus(button.dataset.taskId, 'completed');
                else if (id === 'open-add-order-modal') document.getElementById('add-order-modal').classList.remove('hidden');
                else if (id === 'add-order-item-btn') addNewOrderItemRow();
                else if (classList.contains('remove-item-btn')) button.closest('.order-item-row').remove();
                else if (id === 'save-order-btn') saveOrder(button);
                else if (classList.contains('close-modal-btn')) button.closest('.modal').classList.add('hidden');
                else if (classList.contains('delete-order-btn')) deleteOrder(button.dataset.orderId);
                else if (classList.contains('mark-order-success')) markOrderItemStatus(button.dataset.orderId, button.dataset.itemIndex, 'completed');
                else if (classList.contains('mark-order-fail')) markOrderItemStatus(button.dataset.orderId, button.dataset.itemIndex, 'incomplete');
            });
            document.body.addEventListener('change', (e) => {
                const target = e.target;
                if (['rat-rack', 'rat-shelf', 'rat-side'].includes(target.id)) {
                    currentRack = document.getElementById('rat-rack')?.value || '';
                    currentShelf = document.getElementById('rat-shelf')?.value || '';
                    currentSide = document.getElementById('rat-side')?.value || '';
                    if (currentPage === 'department') renderCrateSummary();
                } else if (target.name === 'rat-size') {
                    currentSize = target.value; currentWeight = '';
                    if (currentPage === 'department') document.getElementById('rat-form-container').innerHTML = renderRatForm();
                } else if (target.name === 'rat-weight') {
                    currentWeight = target.value;
                } else if (target.classList.contains('role-select')) {
                    updateUserRole(target.dataset.userId, target.value);
                }
            });
        }
        
        // --- UI Rendering ---
        function updateDataDrivenUI() {
            const pageRenderers = {
                'dashboard': renderDashboardPage, 'main': renderMainPage,
                'department': renderDepartmentPage, 'order': renderOrderPage, 
                'admin': renderAdminPage, 'analytics': renderAnalyticsPage, 'tasks': renderTasksPage
            };
            if (pageRenderers[currentPage]) {
                pageRenderers[currentPage]();
            } else {
                renderMainPage();
            }
        }

        function renderLoadingUI(message) { /* ... */ }
        function renderError(message) { /* ... */ }
        function renderLoginUI() { /* ... */ }
        
        function renderAppStructure() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="w-full max-w-5xl mx-auto animate-fade-in">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b">
                         <div class="flex items-center mb-4 sm:mb-0"><img src="${currentUser.photoURL}" alt="User" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">${currentUser.displayName}</p><p class="text-xs text-gray-500 uppercase font-bold">${currentUserRole}</p></div></div>
                         <button id="signout-btn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-600 transition">ออกจากระบบ</button>
                     </div>
                     <div id="nav-container" class="flex space-x-2 mb-6 justify-center flex-wrap gap-2"></div>
                     <div id="page-content" class="min-h-[400px]"></div>
                </div>`;
            document.getElementById('modal-container').innerHTML = renderAddOrderModal() + renderDeleteRatModal();
            renderPageContent();
        }

        function renderPageContent() {
             const pageContent = document.getElementById('page-content');
             const navContainer = document.getElementById('nav-container');
             if (!pageContent || !navContainer) return;

             const navButtons = [
                { id: 'dashboard', label: 'Dashboard', roles: ['admin', 'ceo'] },
                { id: 'main', label: 'หน้าหลัก', roles: ['admin', 'ceo', 'officer', 'fattening_staff', 'user'] },
                { id: 'department', label: 'แผนก', roles: ['admin', 'fattening_staff'] },
                { id: 'order', label: 'Order', roles: ['admin', 'officer'] },
                { id: 'analytics', label: 'Analytics', roles: ['admin', 'ceo'] },
                { id: 'tasks', label: 'แจ้งเตือน/งาน', roles: ['admin', 'ceo', 'officer', 'fattening_staff'] },
                { id: 'admin', label: 'Admin', roles: ['admin'] }
             ];

             navContainer.innerHTML = navButtons
                .filter(btn => btn.roles.includes(currentUserRole))
                .map(btn => `<button id="nav-${btn.id}" class="px-4 py-2 rounded-full font-semibold transition ${currentPage === btn.id ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">${btn.label}</button>`)
                .join('');
             
             renderLoadingUI('กำลังโหลดข้อมูล...');
             updateDataDrivenUI();
        }
        
        // --- NEW PAGE RENDERERS ---
        function renderAnalyticsPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;

            const totalPopulation = allRats.length + allDeaths.length;
            const mortalityRate = totalPopulation > 0 ? ((allDeaths.length / totalPopulation) * 100).toFixed(2) : 0;

            pageContent.innerHTML = `<div class="animate-fade-in space-y-6">
                <h1 class="text-2xl font-bold">Analytics - การวิเคราะห์ข้อมูลเชิงลึก</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Mortality Rate Card -->
                    <div class="bg-red-50 p-6 rounded-lg shadow">
                        <h2 class="text-red-800 font-bold text-lg">อัตราการตาย</h2>
                        <p class="text-4xl font-bold text-red-600 mt-2">${mortalityRate}%</p>
                        <p class="text-sm text-gray-500 mt-1">จากข้อมูลหนูทั้งหมด ${totalPopulation} ตัว (ตาย ${allDeaths.length} / มีชีวิต ${allRats.length})</p>
                    </div>

                    <!-- Growth Report Card (Placeholder) -->
                    <div class="bg-green-50 p-6 rounded-lg shadow">
                        <h2 class="text-green-800 font-bold text-lg">รายงานการเจริญเติบโต</h2>
                        <p class="text-gray-500 mt-2">เร็วๆ นี้...</p>
                    </div>

                    <!-- Production Efficiency Card (Placeholder) -->
                    <div class="bg-yellow-50 p-6 rounded-lg shadow">
                        <h2 class="text-yellow-800 font-bold text-lg">ประสิทธิภาพการผลิต</h2>
                        <p class="text-gray-500 mt-2">เร็วๆ นี้...</p>
                    </div>
                </div>
            </div>`;
        }
        
        function renderTasksPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;

            const canAssignTasks = ['admin', 'officer'].includes(currentUserRole);
            const canCompleteTasks = ['fattening_staff'].includes(currentUserRole);

            const taskInputHtml = canAssignTasks ? `
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="font-bold text-lg mb-2">มอบหมายงานใหม่</h2>
                    <div class="flex gap-2">
                        <input type="text" id="new-task-input" class="w-full p-2 border rounded" placeholder="พิมพ์ข้อความงาน...">
                        <button id="save-task-btn" class="bg-blue-500 text-white px-4 py-2 rounded font-semibold">มอบหมาย</button>
                    </div>
                </div>` : '';

            const pendingTasks = allTasks.filter(t => t.status === 'pending');
            const completedTasks = allTasks.filter(t => t.status === 'completed');

            const renderTaskList = (tasks, title, isPending) => {
                if (tasks.length === 0) return '';
                return `<div class="mt-4">
                    <h3 class="font-bold mb-2">${title}</h3>
                    <div class="space-y-2">
                        ${tasks.map(task => `
                            <div class="bg-gray-100 p-3 rounded flex justify-between items-center ${!isPending ? 'opacity-60' : ''}">
                                <div>
                                    <p class="${!isPending ? 'line-through' : ''}">${task.text}</p>
                                    <p class="text-xs text-gray-500">โดย: ${task.createdBy} - ${task.createdAt ? new Date(task.createdAt.seconds * 1000).toLocaleDateString('th-TH') : ''}</p>
                                </div>
                                ${isPending && canCompleteTasks ? `<button class="mark-task-complete-btn bg-green-500 text-white px-3 py-1 text-sm rounded" data-task-id="${task.id}">ทำเสร็จแล้ว</button>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            pageContent.innerHTML = `<div class="animate-fade-in space-y-6">
                <h1 class="text-2xl font-bold">แจ้งเตือน / งาน</h1>
                ${taskInputHtml}
                <div class="bg-gray-50 p-4 rounded-lg">
                    ${renderTaskList(pendingTasks, 'งานที่ต้องทำ', true)}
                    ${renderTaskList(completedTasks, 'งานที่เสร็จสิ้นแล้ว', false)}
                </div>
            </div>`;
        }

        // --- Other Page Renderers (Mainly unchanged) ---
        function renderMainPage() { /* ... */ }
        function renderDashboardPage() { /* ... */ }
        function renderDepartmentPage() { /* ... */ }
        function renderFatteningContent() { /* ... */ }
        function renderBreedingDeptPage() { /* ... */ }
        function renderOrderPage() { /* ... */ }
        function renderActiveOrdersSummary() { /* ... */ }
        function renderAdminPage() { /* ... */ }
        function renderRatForm() { /* ... */ }
        function renderCrateSummary() { /* ... */ }
        function renderAddOrderModal() { /* ... */ }
        function renderDeleteRatModal() { /* ... */ }
        function addNewOrderItemRow() { /* ... */ }
        function calculateDashboardMetrics() { /* ... */ }
        function createBarChart(canvasId, labels, data) { /* ... */ }
        function createDoughnutChart(canvasId, labels, data) { /* ... */ }

    </script>
</body>
</html>

