<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มหนู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">
    <div id="app-container" class="container mx-auto p-4 bg-white rounded-2xl shadow-2xl min-h-[90vh] flex flex-col items-center justify-center">
        <!-- สถานะโหลดเริ่มต้น -->
        <div class="text-gray-500 flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            กำลังเริ่มต้น...
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, getDocs, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App ID ---
        const appId = 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAkCMLbcWCT9jhkRVU2bhVMjdWaeuMm1vo",
            authDomain: "eratfarm-bd035.firebaseapp.com",
            projectId: "eratfarm-bd035",
            storageBucket: "eratfarm-bd035.appspot.com",
            messagingSenderId: "462976136580",
            appId: "1:462976136580:web:a1ef8ee2b32f1cc4bf19d1",
            measurementId: "G-QHBHS05KRL"
        };
        
        // --- App State ---
        let app, db, auth;
        let currentUser = null, currentUserRole = null;
        let allRats = [], allOrders = [];
        let currentPage = 'main';
        let unsubscribeListeners = [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    clearAllListeners();
                    if (user) {
                        currentUser = user;
                        await checkUserRole(user);
                        renderAppStructure();
                        attachDataListeners();
                    } else {
                        resetAppState();
                        renderLoginUI();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                renderError("การเริ่มต้น Firebase ล้มเหลว: " + error.message);
            }
        }

        // --- Data Management ---
        function attachDataListeners() {
            const ratsPath = `artifacts/${appId}/public/data/rats`;
            const ordersPath = `artifacts/${appId}/public/data/orders`;

            unsubscribeListeners.push(onSnapshot(collection(db, ratsPath), 
                (snapshot) => { 
                    allRats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                    updateDataDrivenUI(); 
                },
                (err) => { console.error("Rats Listener Error:", err); renderError("ไม่สามารถโหลดข้อมูลหนูได้: " + err.message); })
            );
            unsubscribeListeners.push(onSnapshot(collection(db, ordersPath),
                (snapshot) => { 
                    allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                    updateDataDrivenUI(); 
                },
                (err) => { console.error("Orders Listener Error:", err); renderError("ไม่สามารถโหลดข้อมูลออเดอร์ได้: " + err.message); })
            );
        }

        function clearAllListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        }

        function resetAppState() {
            currentUser = null; currentUserRole = null;
            allRats = []; allOrders = [];
            currentPage = 'main';
        }

        async function checkUserRole(user) {
            const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, user.uid);
            try {
                const docSnap = await getDoc(userRoleRef);
                if (docSnap.exists()) {
                    currentUserRole = docSnap.data().role;
                } else {
                    const rolesQuery = query(collection(db, `artifacts/${appId}/public/data/user_roles`));
                    const rolesSnapshot = await getDocs(rolesQuery);
                    const newRole = rolesSnapshot.empty ? 'admin' : 'user';
                    await setDoc(userRoleRef, { role: newRole, email: user.email, name: user.displayName });
                    currentUserRole = newRole;
                }
                if ((['admin', 'ceo'].includes(currentUserRole)) && currentPage === 'main') {
                    currentPage = 'dashboard';
                }
            } catch (error) {
                console.error("Check Role Error:", error);
                renderError("ไม่สามารถตรวจสอบสิทธิ์ผู้ใช้ได้: " + error.message + "<br>กรุณาตรวจสอบ Firestore Security Rules ของคุณ");
            }
        }
        
        // --- Authentication ---
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("Sign In Error:", error); }
        }
        async function signOutUser() {
            try { await signOut(auth); } catch (error) { console.error("Sign Out Error:", error); }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.id || '';

                if (id === 'google-signin-btn') signInWithGoogle();
                else if (id === 'signout-btn') signOutUser();
                else if (id.startsWith('nav-')) {
                    currentPage = id.split('-')[1];
                    renderPageContent();
                }
            });
        }
        
        // --- UI Rendering ---
        function updateDataDrivenUI() {
            const pageRenderers = {
                'dashboard': renderDashboardPage, 'main': renderMainPage,
                'manage': renderManagePage, 'order': renderOrderPage, 'admin': renderAdminPage
            };
            if (pageRenderers[currentPage]) {
                pageRenderers[currentPage]();
            } else {
                renderMainPage(); // Fallback
            }
        }

        function renderLoadingUI(message) {
            const container = document.getElementById('page-content');
            if(container) container.innerHTML = `<div class="text-gray-500 flex items-center justify-center p-8"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${message}</div>`;
        }

        function renderError(message) {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `<div class="text-red-500 text-center p-4 bg-red-50 rounded-lg"><h2 class="font-bold text-lg">เกิดข้อผิดพลาด</h2><p class="mt-2">${message}</p></div>`;
        }
        
        function renderLoginUI() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-md mx-auto text-center animate-fade-in">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ระบบจัดการฟาร์มหนู</h1>
                    <p class="text-gray-600 mb-6">กรุณาลงชื่อเข้าใช้เพื่อเริ่มต้น</p>
                    <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full hover:bg-blue-700 transition flex items-center justify-center">
                        <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691c-1.219 2.22-1.994 4.7-1.994 7.309s.775 5.089 1.994 7.309l-5.657 5.657C.654 30.65 0 27.464 0 24s.654-6.65 1.748-9.358z"/><path fill="#4CAF50" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657c-1.746 1.17-3.956 1.849-6.302 1.849-4.207 0-7.837-2.37-9.84-5.698l-5.657 5.657C9.043 43.125 15.93 48 24 48z"/><path fill="#1976D2" d="M43.611 20.083L43.595 20H24v8h11.303a12.042 12.042 0 01-4.087 5.571l5.657 5.657C40.071 35.731 44 30.34 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                        ลงชื่อเข้าใช้ด้วย Google
                    </button>
                </div>`;
        }
        
        function renderAppStructure() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="w-full max-w-5xl mx-auto animate-fade-in">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b">
                         <div class="flex items-center mb-4 sm:mb-0"><img src="${currentUser.photoURL}" alt="User" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">${currentUser.displayName}</p><p class="text-xs text-gray-500 uppercase font-bold">${currentUserRole}</p></div></div>
                         <button id="signout-btn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-600 transition">ออกจากระบบ</button>
                     </div>
                     <div id="nav-container" class="flex space-x-2 mb-6 justify-center flex-wrap gap-2"></div>
                     <div id="page-content" class="min-h-[400px]"></div>
                </div>`;
            renderPageContent();
        }

        function renderPageContent() {
             const pageContent = document.getElementById('page-content');
             const navContainer = document.getElementById('nav-container');
             if (!pageContent || !navContainer) return;

             const navButtons = [
                { id: 'dashboard', label: 'Dashboard', roles: ['admin', 'ceo'] },
                { id: 'main', label: 'หน้าหลัก', roles: ['admin', 'ceo', 'officer', 'fattening_staff', 'user'] },
                { id: 'manage', label: 'แผนกขุน', roles: ['admin', 'fattening_staff'] },
                { id: 'order', label: 'Order', roles: ['admin', 'officer'] },
                { id: 'admin', label: 'Admin', roles: ['admin'] }
             ];

             navContainer.innerHTML = navButtons
                .filter(btn => btn.roles.includes(currentUserRole))
                .map(btn => `<button id="nav-${btn.id}" class="px-4 py-2 rounded-full font-semibold transition ${currentPage === btn.id ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">${btn.label}</button>`)
                .join('');
             
             renderLoadingUI('กำลังโหลดข้อมูล...');
             updateDataDrivenUI();
        }
        
        function renderMainPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            pageContent.innerHTML = `<div class="animate-fade-in space-y-6">
                <div class="p-6 bg-gray-50 rounded-lg">
                    <h1 class="text-2xl font-bold text-gray-800">ภาพรวมฟาร์ม</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="bg-blue-100 p-4 rounded-lg"><p class="text-blue-800">จำนวนหนูทั้งหมด</p><p class="text-3xl font-bold text-blue-900">${allRats.length} ตัว</p></div>
                        <div class="bg-green-100 p-4 rounded-lg"><p class="text-green-800">ออเดอร์ที่ใช้งาน</p><p class="text-3xl font-bold text-green-900">${allOrders.filter(o => o.items && o.items.some(i => i.sent < i.quantity)).length} รายการ</p></div>
                    </div>
                </div>
            </div>`;
        }

        function renderDashboardPage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div class="animate-fade-in"><h1 class="text-2xl font-bold">Dashboard</h1><p>เนื้อหาสำหรับ Dashboard</p></div>`;
        }
        function renderManagePage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div class="animate-fade-in"><h1 class="text-2xl font-bold">แผนกขุน</h1><p>เนื้อหาสำหรับแผนกขุน</p></div>`;
        }
        function renderOrderPage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div class="animate-fade-in"><h1 class="text-2xl font-bold">จัดการ Order</h1><p>เนื้อหาสำหรับจัดการ Order</p></div>`;
        }
        function renderAdminPage() {
            const pageContent = document.getElementById('page-content');
            if(pageContent) pageContent.innerHTML = `<div class="animate-fade-in"><h1 class="text-2xl font-bold">Admin</h1><p>เนื้อหาสำหรับ Admin</p></div>`;
        }
    </script>
</body>
</html>

