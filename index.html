<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มหนู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .modal { transition: opacity 0.3s ease; }
        /* God Mode Toggle CSS */
        .god-mode-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .god-mode-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #ef4444; /* red-500 */
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">
    <div id="app-container" class="container mx-auto p-4 bg-white rounded-2xl shadow-2xl min-h-[90vh] flex flex-col items-center justify-center">
        <!-- สถานะโหลดเริ่มต้น -->
        <div class="text-gray-500 flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            กำลังเริ่มต้น...
        </div>
    </div>
    <div id="modal-container"></div>
    <div id="message-box" class="fixed top-4 right-4 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, where, getDocs, updateDoc, setDoc, getDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App ID ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAkCMLbcWCT9jhkRVU2bhVMjdWaeuMm1vo",
            authDomain: "eratfarm-bd035.firebaseapp.com",
            projectId: "eratfarm-bd035",
            storageBucket: "eratfarm-bd035.appspot.com",
            messagingSenderId: "462976136580",
            appId: "1:462976136580:web:a1ef8ee2b32f1cc4bf19d1",
            measurementId: "G-QHBHS05KRL"
        };
        
        // --- App State ---
        let app, db, auth;
        let currentUser = null, currentUserRole = null;
        let allRats = [], allOrders = [], allUsers = [], allDeaths = [];
        let farmConfig = { rackCount: 6 }; // Default config
        let currentPage = 'main';
        let subPage = '';
        let fatteningSubPage = 'crate';
        let godMode = false;
        let currentRack = '', currentShelf = '', currentSide = '', currentSize = '', currentWeight = '';
        let chartInstances = {};
        let unsubscribeListeners = [];
        const ratSizeOptions = [
            { size: "JUMP", minWeight: 9, maxWeight: 13, order: 0 }, { size: "S", minWeight: 14, maxWeight: 18, order: 1 },
            { size: "M", minWeight: 19, maxWeight: 23, order: 2 }, { size: "L", minWeight: 24, maxWeight: 28, order: 3 },
            { size: "XL", minWeight: 29, maxWeight: 33, order: 4 }, { size: "XXL", minWeight: 34, maxWeight: 38, order: 5 },
            { size: "XXL+", minWeight: 39, maxWeight: 45, order: 6 }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
            godMode = localStorage.getItem('godMode') === 'true';
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    clearAllListeners();
                    if (user) {
                        currentUser = user;
                        await checkUserRole(user);
                        renderAppStructure();
                        attachDataListeners();
                    } else {
                        resetAppState();
                        renderLoginUI();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                renderError("การเริ่มต้น Firebase ล้มเหลว: " + error.message);
            }
        }

        // --- Data Management ---
        function attachDataListeners() {
            const paths = {
                rats: `artifacts/${appId}/public/data/rats`,
                orders: `artifacts/${appId}/public/data/orders`,
                users: `artifacts/${appId}/public/data/user_roles`,
                deaths: `artifacts/${appId}/public/data/deaths`,
                config: `artifacts/${appId}/public/data/farm_config`,
            };
            const addListener = (path, stateUpdater, onError) => {
                unsubscribeListeners.push(onSnapshot(collection(db, path), 
                    (snapshot) => { stateUpdater(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); updateDataDrivenUI(); },
                    onError
                ));
            };
            
            unsubscribeListeners.push(onSnapshot(doc(db, paths.config, 'main'), (docSnap) => {
                if (docSnap.exists()) {
                    farmConfig = docSnap.data();
                } else {
                    farmConfig = { rackCount: 6 }; // Fallback to default
                }
                updateDataDrivenUI();
            }));

            addListener(paths.rats, (data) => allRats = data, (err) => console.error("Rats Listener Error:", err));
            addListener(paths.orders, (data) => allOrders = data, (err) => console.error("Orders Listener Error:", err));
            addListener(paths.deaths, (data) => allDeaths = data, (err) => console.error("Deaths Listener Error:", err));
            
            if (currentUserRole === 'admin') {
                 addListener(paths.users, (data) => allUsers = data, (err) => console.error("Users Listener Error:", err));
            }
        }

        function clearAllListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        }

        function resetAppState() {
            currentUser = null; currentUserRole = null;
            allRats = [], allOrders = [], allUsers = [], allDeaths = [];
            farmConfig = { rackCount: 6 };
            currentPage = 'main'; subPage = ''; fatteningSubPage = 'crate';
            currentRack = '', currentShelf = '', currentSide = '', currentSize = '', currentWeight = '';
        }

        async function checkUserRole(user) {
            const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, user.uid);
            try {
                const docSnap = await getDoc(userRoleRef);
                if (docSnap.exists()) {
                    currentUserRole = docSnap.data().role;
                } else {
                    const rolesQuery = query(collection(db, `artifacts/${appId}/public/data/user_roles`));
                    const rolesSnapshot = await getDocs(rolesQuery);
                    const newRole = rolesSnapshot.empty ? 'admin' : 'user';
                    await setDoc(userRoleRef, { role: newRole, email: user.email, name: user.displayName });
                    currentUserRole = newRole;
                }
                if ((['admin', 'ceo'].includes(currentUserRole)) && currentPage === 'main') {
                    currentPage = 'dashboard';
                }
            } catch (error) {
                console.error("Check Role Error:", error);
                renderError("ไม่สามารถตรวจสอบสิทธิ์ผู้ใช้ได้: " + error.message + "<br>กรุณาตรวจสอบ Firestore Security Rules");
            }
        }
        
        // --- Logic Functions ---
        async function addRack(button) {
            if (currentUserRole !== 'admin') {
                showMessage("คุณไม่มีสิทธิ์ในการเพิ่ม Rack", "error");
                return;
            }
            button.disabled = true;
            const configRef = doc(db, `artifacts/${appId}/public/data/farm_config`, 'main');
            try {
                const newRackCount = (farmConfig.rackCount || 6) + 1;
                await setDoc(configRef, { rackCount: newRackCount }, { merge: true });
                showMessage(`เพิ่ม Rack เรียบร้อยแล้ว! จำนวน Rack ปัจจุบันคือ ${newRackCount}`, "success");
            } catch (e) {
                console.error("Error adding rack:", e);
                showMessage("เกิดข้อผิดพลาดในการเพิ่ม Rack: " + e.message, "error");
            } finally {
                button.disabled = false;
            }
        }
        
        async function deleteRack(button) {
            if (currentUserRole !== 'admin') {
                showMessage("คุณไม่มีสิทธิ์ในการลบ Rack", "error");
                return;
            }
            const currentRackCount = farmConfig.rackCount || 6;
            if (currentRackCount <= 1) {
                showMessage("ไม่สามารถลบ Rack ได้อีกแล้ว (ต้องมีอย่างน้อย 1 Rack)", "error");
                return;
            }

            const modal = document.getElementById('confirm-modal');
            const modalMessage = document.getElementById('confirm-modal-message');
            const confirmButton = document.getElementById('confirm-modal-confirm-btn');

            modalMessage.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบ Rack ${currentRackCount}? การกระทำนี้ไม่สามารถย้อนกลับได้`;
            confirmButton.dataset.action = 'deleteRack';
            confirmButton.dataset.rackCount = currentRackCount;
            modal.classList.remove('hidden');
        }

        async function confirmDeleteRack(rackCount, button) {
            button.disabled = true;
            const configRef = doc(db, `artifacts/${appId}/public/data/farm_config`, 'main');
            try {
                const newRackCount = parseInt(rackCount, 10) - 1;
                await setDoc(configRef, { rackCount: newRackCount }, { merge: true });
                showMessage(`ลบ Rack เรียบร้อยแล้ว! จำนวน Rack ปัจจุบันคือ ${newRackCount}`, "success");
            } catch (e) {
                console.error("Error deleting rack:", e);
                showMessage("เกิดข้อผิดพลาดในการลบ Rack: " + e.message, "error");
            } finally {
                button.disabled = false;
                document.getElementById('confirm-modal').classList.add('hidden');
            }
        }

        async function clearCrate() {
            if (!currentRack || !currentShelf || !currentSide) {
                showMessage("กรุณาเลือกตำแหน่งของกระบะก่อน", "warning");
                return;
            }
            const crateRats = allRats.filter(r => r.rack === currentRack && r.shelf == currentShelf && r.side === currentSide);
            if (crateRats.length === 0) {
                showMessage("กระบะนี้ไม่มีหนู", "warning");
                return;
            }
            const modal = document.getElementById('confirm-modal');
            const modalMessage = document.getElementById('confirm-modal-message');
            const confirmButton = document.getElementById('confirm-modal-confirm-btn');

            modalMessage.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบหนูทั้งหมด ${crateRats.length} ตัวในกระบะ ${currentRack} / ชั้น ${currentShelf} / ${currentSide}?`;
            confirmButton.dataset.action = 'clearCrate';
            modal.classList.remove('hidden');
        }

        async function confirmClearCrate(button) {
            button.disabled = true;
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/rats`), 
                    where("rack", "==", currentRack), 
                    where("shelf", "==", currentShelf), 
                    where("side", "==", currentSide)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { 
                    showMessage("ไม่พบหนูในกระบะที่เลือก", "warning"); 
                    return; 
                }

                const batch = writeBatch(db);
                querySnapshot.docs.forEach(d => {
                    batch.delete(doc(db, `artifacts/${appId}/public/data/rats`, d.id));
                });
                await batch.commit();

                showMessage(`ลบหนูทั้งหมดจากกระบะเรียบร้อยแล้ว`, "success");
            } catch (e) { 
                console.error("Error clearing crate:", e); 
                showMessage("เกิดข้อผิดพลาดในการลบหนูทั้งหมด", "error");
            } finally { 
                button.disabled = false; 
                document.getElementById('confirm-modal').classList.add('hidden');
            }
        }


        async function deleteClosestRat(button) {
            const weightInput = document.getElementById('delete-rat-weight-input');
            const targetWeight = parseFloat(weightInput.value);
            if (!targetWeight || isNaN(targetWeight) || targetWeight <= 0) {
                showMessage("กรุณากรอกน้ำหนักให้ถูกต้อง", "error");
                return;
            }
            if (!currentRack || !currentShelf || !currentSide) {
                showMessage("เกิดข้อผิดพลาด: ไม่พบตำแหน่งกระบะ", "error");
                return;
            }
            
            const modal = document.getElementById('confirm-modal');
            const modalMessage = document.getElementById('confirm-modal-message');
            const confirmButton = document.getElementById('confirm-modal-confirm-btn');

            modalMessage.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบหนูตัวนี้?`;
            confirmButton.dataset.action = 'deleteRat';
            modal.classList.remove('hidden');
        }

        async function confirmDeleteRat(button) {
            const weightInput = document.getElementById('delete-rat-weight-input');
            const targetWeight = parseFloat(weightInput.value);
            button.disabled = true;
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/rats`), where("rack", "==", currentRack), where("shelf", "==", currentShelf), where("side", "==", currentSide));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { 
                    showMessage("ไม่พบหนูในกระบะที่เลือก", "warning"); 
                    return; 
                }

                const candidates = querySnapshot.docs.map(d => {
                    const ratData = d.data();
                    const estimatedWeight = ratData.weight + ((new Date() - new Date(ratData.createdAt)) / 86400000 * 0.9);
                    return {id: d.id, ...ratData, estimatedWeight };
                });
                let closestRat = candidates.reduce((prev, curr) => (Math.abs(curr.estimatedWeight - targetWeight) < Math.abs(prev.estimatedWeight - targetWeight) ? curr : prev));
                
                const deathData = { ...closestRat, deathDate: serverTimestamp(), department: 'fattening' };
                delete deathData.estimatedWeight; 
                await addDoc(collection(db, `artifacts/${appId}/public/data/deaths`), deathData);
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id));
                showMessage(`บันทึกการตายและลบหนูเรียบร้อยแล้ว`, "success");
                document.getElementById('delete-rat-modal').classList.add('hidden');
            } catch (e) { 
                console.error("Error deleting rat:", e); 
                showMessage("เกิดข้อผิดพลาดในการลบหนู", "error");
            } finally { 
                button.disabled = false; 
                document.getElementById('confirm-modal').classList.add('hidden');
            }
        }
        
        async function saveRat(button) {
            if (!currentRack || !currentShelf || !currentSide || !currentSize || !currentWeight) {
                showMessage("กรุณากรอกข้อมูลให้ครบถ้วน", "error");
                return;
            }
            
            const crateRats = allRats.filter(r => r.rack === currentRack && r.shelf == currentShelf && r.side === currentSide);
            if (crateRats.length >= 40) {
                showMessage("กระบะเต็มแล้ว (สูงสุด 40 ตัว)", "warning");
                return;
            }

            button.disabled = true;
            const ratData = { rack: currentRack, shelf: currentShelf, side: currentSide, size: currentSize, weight: parseFloat(currentWeight), createdAt: new Date().toISOString() };
            try { 
                await addDoc(collection(db, `artifacts/${appId}/public/data/rats`), ratData); 
                showMessage("เพิ่มหนูสำเร็จ!", "success");
            } catch(e) { 
                console.error(e); 
                showMessage("เกิดข้อผิดพลาดในการเพิ่มหนู", "error");
            } finally { 
                button.disabled = false; 
            }
        }

        async function returnRatToCrate(button) {
            if (!currentRack || !currentShelf || !currentSide || !currentWeight) {
                showMessage("กรุณาเลือกตำแหน่งและกรอกน้ำหนักหนูที่จะส่งคืน", "error");
                return;
            }
            const crateRats = allRats.filter(r => r.rack === currentRack && r.shelf == currentShelf && r.side === currentSide);
            if (crateRats.length >= 40) {
                showMessage("กระบะเต็มแล้ว (สูงสุด 40 ตัว) ไม่สามารถส่งคืนได้", "warning");
                return;
            }
            button.disabled = true;
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/rats`), 
                    where("rack", "==", currentRack), 
                    where("shelf", "==", currentShelf), 
                    where("side", "==", currentSide)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    showMessage("ไม่พบหนูในกระบะที่เลือก", "warning");
                    button.disabled = false;
                    return;
                }

                const now = new Date();
                const weightToUpdate = parseFloat(currentWeight);
                const candidates = querySnapshot.docs.map(doc => {
                    const rat = { id: doc.id, ...doc.data() };
                    const daysAgo = (now - new Date(rat.createdAt)) / (1000 * 60 * 60 * 24);
                    const estimatedWeight = rat.weight + (daysAgo * 0.9);
                    return { ...rat, estimatedWeight };
                });

                let closestRat = candidates.reduce((prev, curr) => 
                    (Math.abs(curr.estimatedWeight - weightToUpdate) < Math.abs(prev.estimatedWeight - weightToUpdate) ? curr : prev)
                );
                
                await updateDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id), {
                    weight: weightToUpdate,
                    createdAt: new Date().toISOString()
                });

                showMessage(`อัปเดตน้ำหนักหนู (น้ำหนักประมาณ ${closestRat.estimatedWeight.toFixed(1)}g) เป็น ${weightToUpdate}g เรียบร้อยแล้ว`, "success");

            } catch (e) {
                console.error("Error returning rat to crate:", e);
                showMessage("เกิดข้อผิดพลาดในการอัปเดตข้อมูลหนู", "error");
            } finally {
                button.disabled = false;
                document.getElementById('action-modal').classList.add('hidden');
            }
        }

        async function saveOrder(button) {
             button.disabled = true;
             const orderId = document.getElementById('edit-order-id')?.value;
             const orderName = document.getElementById('order-name-input').value || 'New Order';
             const department = document.getElementById('department-select').value;
             const orderPriority = document.getElementById('order-priority-select').value;
             if (!department || !orderPriority) {
                 showMessage("กรุณาเลือกแผนกและลำดับความสำคัญของ Order", "error");
                 button.disabled = false;
                 return;
             }
             const items = [];
             document.querySelectorAll('#order-items-container .order-item-row').forEach(row => {
                 const size = row.querySelector('.size-select').value;
                 const quantity = parseInt(row.querySelector('.quantity-input').value, 10);
                 const minWeight = parseInt(row.querySelector('.min-weight-input').value, 10);
                 const maxWeight = parseInt(row.querySelector('.max-weight-input').value, 10);
                 const itemType = row.querySelector('.item-type-select').value;
                 if (size && quantity > 0) {
                     items.push({ size, quantity, minWeight, maxWeight, type: itemType, sent: 0, status: 'pending' });
                 }
             });
             if (items.length === 0) {
                 showMessage("กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ", "error");
                 button.disabled = false;
                 return;
             }
             try {
                 if (orderId) {
                     await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId), { 
                         name: orderName,
                         department,
                         priority: orderPriority,
                         items
                     });
                     showMessage("แก้ไข Order สำเร็จ", "success");
                 } else {
                     await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), { 
                         name: orderName, 
                         department: department, 
                         priority: orderPriority,
                         items, 
                         createdAt: serverTimestamp() 
                     });
                     showMessage("บันทึก Order สำเร็จ", "success");
                 }
                 document.getElementById('add-order-modal').classList.add('hidden');
             } catch (e) { 
                 console.error("Error saving order:", e); 
                 showMessage("เกิดข้อผิดพลาดในการบันทึก Order", "error");
             } finally {
                 button.disabled = false;
             }
        }

        async function deleteOrder(orderId) {
            const modal = document.getElementById('confirm-modal');
            const modalMessage = document.getElementById('confirm-modal-message');
            const confirmButton = document.getElementById('confirm-modal-confirm-btn');

            modalMessage.textContent = 'คุณต้องการลบ Order นี้ใช่หรือไม่?';
            confirmButton.dataset.action = 'deleteOrder';
            confirmButton.dataset.orderId = orderId;
            modal.classList.remove('hidden');
        }

        async function confirmDeleteOrder(orderId, button) {
            button.disabled = true;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId));
                showMessage("ลบ Order สำเร็จ", "success");
            } catch(e) { 
                console.error(e); 
                showMessage("เกิดข้อผิดพลาดในการลบ Order", "error");
            } finally {
                button.disabled = false;
                document.getElementById('confirm-modal').classList.add('hidden');
            }
        }

        async function editOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                showMessage("ไม่พบ Order ที่ต้องการแก้ไข", "error");
                return;
            }
            const modal = document.getElementById('add-order-modal');
            const nameInput = document.getElementById('order-name-input');
            const departmentSelect = document.getElementById('department-select');
            const prioritySelect = document.getElementById('order-priority-select');
            const itemsContainer = document.getElementById('order-items-container');
            const saveButton = document.getElementById('save-order-btn');

            nameInput.value = order.name;
            departmentSelect.value = order.department;
            prioritySelect.value = order.priority;
            itemsContainer.innerHTML = '';
            
            order.items.forEach(item => {
                addNewOrderItemRow(item);
            });

            saveButton.textContent = 'บันทึกการแก้ไข';
            saveButton.dataset.orderId = orderId;

            modal.classList.remove('hidden');
        }

        async function updateUserRole(userId, newRole) {
             try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/user_roles`, userId), { role: newRole });
                showMessage("อัปเดตสิทธิ์ผู้ใช้สำเร็จ", "success");
             } catch(e) { 
                 console.error(e); 
                 showMessage("เกิดข้อผิดพลาดในการอัปเดตสิทธิ์ผู้ใช้", "error");
             }
        }

        async function sendRatToOrder(button) {
            let requiredFields = godMode ? ['currentSize', 'currentWeight'] : ['currentRack', 'currentShelf', 'currentSide', 'currentSize', 'currentWeight'];
            let missingFields = requiredFields.filter(field => !eval(field));
            if(missingFields.length > 0) {
                 showMessage("กรุณากรอกข้อมูลให้ครบถ้วน", "error");
                 return;
            }

            const selectedRatSizeData = ratSizeOptions.find(s => s.size === currentSize);
            const currentRatOrder = selectedRatSizeData.order;
            const currentRatWeight = parseFloat(currentWeight);
            const isLiveRat = currentRatWeight >= 9; // Assumption: live rats are usually heavier
            const ratType = isLiveRat ? 'หนูเป็น' : 'หนูแช่';

            let targetOrder = null;
            let targetItemIndex = -1;
            let orderIsSecondary = false;

            // Find Primary Order
            let primaryOrderCandidates = allOrders.filter(o => 
                o.department === 'fattening' && o.priority === 'หลัก' && o.items.some(item => 
                    item.size === currentSize && item.type === ratType && item.status === 'pending'
                )
            );

            if (primaryOrderCandidates.length > 0) {
                 primaryOrderCandidates.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                 targetOrder = primaryOrderCandidates[0];
                 targetItemIndex = targetOrder.items.findIndex(item => item.size === currentSize && item.type === ratType && item.status === 'pending');
            }

            // If no primary order, find Secondary Order
            if (!targetOrder) {
                const secondaryOrderCandidates = allOrders.filter(o => o.priority === 'รอง' && o.department === 'fattening');
                const sortedSecondaryOrders = secondaryOrderCandidates.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                for (const order of sortedSecondaryOrders) {
                    if (isLiveRat) {
                         const largerSizeOptions = ratSizeOptions.filter(s => s.order > currentRatOrder);
                         for (const largerSizeData of largerSizeOptions) {
                             const itemIndex = (order.items || []).findIndex(item => 
                                 item.size === largerSizeData.size && item.type === ratType && item.status === 'pending' && currentRatWeight <= item.maxWeight
                             );
                             if (itemIndex !== -1) {
                                 targetOrder = order;
                                 targetItemIndex = itemIndex;
                                 orderIsSecondary = true;
                                 break;
                             }
                         }
                    } else { // Frozen rat logic
                         const smallerSizeOptions = ratSizeOptions.filter(s => s.order < currentRatOrder);
                         for (let i = smallerSizeOptions.length - 1; i >= 0; i--) {
                             const smallerSizeData = smallerSizeOptions[i];
                             const itemIndex = (order.items || []).findIndex(item => 
                                 item.size === smallerSizeData.size && item.type === ratType && item.status === 'pending' && currentRatWeight >= item.minWeight
                             );
                             if (itemIndex !== -1) {
                                 targetOrder = order;
                                 targetItemIndex = itemIndex;
                                 orderIsSecondary = true;
                                 break;
                             }
                         }
                    }
                    if (targetOrder) break;
                }
            }

            if (!targetOrder) {
                showMessage(`ไม่พบ Order ที่ต้องการหนูไซส์ ${currentSize} หรือ Order ที่ใกล้เคียง`, "warning");
                return;
            }
             if (godMode) {
                 const targetItem = targetOrder.items[targetItemIndex];
                 if (currentRatWeight < targetItem.minWeight || currentRatWeight > targetItem.maxWeight) {
                     showMessage(`น้ำหนักหนู (${currentRatWeight}g) ไม่ตรงกับช่วงน้ำหนักของ Order (${targetItem.minWeight}-${targetItem.maxWeight}g)`, "warning");
                     button.disabled = false;
                     return;
                 }
             }

            button.disabled = true;

            try {
                if (!godMode) {
                    const q = query(collection(db, `artifacts/${appId}/public/data/rats`),
                        where("rack", "==", currentRack), where("shelf", "==", currentShelf), where("side", "==", currentSide));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        showMessage("ไม่พบหนูในกระบะที่เลือก", "warning");
                        button.disabled = false; return;
                    }

                    const now = new Date();
                    const weightToFind = parseFloat(currentWeight);
                    const candidates = querySnapshot.docs.map(doc => {
                        const rat = { id: doc.id, ...doc.data() };
                        const daysAgo = (now - new Date(rat.createdAt)) / (1000 * 60 * 60 * 24);
                        const estimatedWeight = rat.weight + (daysAgo * 0.9);
                        return { ...rat, estimatedWeight };
                    });
                    
                    const targetItem = targetOrder.items[targetItemIndex];
                    const validCandidates = candidates.filter(c => c.estimatedWeight >= targetItem.minWeight && c.estimatedWeight <= targetItem.maxWeight);

                    if (validCandidates.length === 0) {
                         showMessage("ไม่พบหนูที่น้ำหนักอยู่ในช่วง Order นี้", "warning");
                         button.disabled = false; return;
                    }

                    let closestRat = validCandidates.reduce((prev, curr) => (Math.abs(curr.estimatedWeight - weightToFind) < Math.abs(prev.estimatedWeight - weightToFind) ? curr : prev));

                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/rats`, closestRat.id));
                }
                
                const updatedItems = [...targetOrder.items];
                updatedItems[targetItemIndex].sent = (updatedItems[targetItemIndex].sent || 0) + 1;
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, targetOrder.id), { items: updatedItems });

                const orderTypeLabel = orderIsSecondary ? 'Order รอง' : 'Order หลัก';
                showMessage(`ส่งหนู 1 ตัวเข้า ${orderTypeLabel} '${targetOrder.name}' เรียบร้อยแล้ว`, "success");
            } catch (e) {
                console.error("Error sending rat to order:", e);
                showMessage("เกิดข้อผิดพลาดในการส่ง Order", "error");
            } finally {
                button.disabled = false;
                document.getElementById('action-modal').classList.add('hidden');
            }
        }
        
        async function sendQuickRatToOrder(orderId, itemIndex) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            const updatedItems = [...order.items];
            const item = updatedItems[itemIndex];
            if (item.status !== 'pending') {
                 showMessage("Order รายการนี้ถูกปิดไปแล้ว", "warning");
                 return;
            }
            item.sent = (item.sent || 0) + 1;
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId), { items: updatedItems });
                showMessage("ส่งหนูด่วนสำเร็จ!", "success");
            } catch (e) { 
                console.error("Error sending quick rat:", e);
                showMessage("เกิดข้อผิดพลาดในการส่งหนูด่วน", "error");
            }
        }

        async function markOrderItemStatus(orderId, itemIndex, status) {
            if (!['admin', 'officer'].includes(currentUserRole)) {
                 showMessage("คุณไม่มีสิทธิ์ในการจัดการ Order", "error");
                 return;
            }
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const updatedItems = [...order.items];
            if (updatedItems[itemIndex]) {
                updatedItems[itemIndex].status = status;
            }

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId), { items: updatedItems });
                showMessage("อัปเดตสถานะ Order สำเร็จ", "success");
            } catch (e) {
                console.error("Error updating order status:", e);
                showMessage("เกิดข้อผิดพลาดในการอัปเดตสถานะ", "error");
            }
        }

        // --- Authentication ---
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("Sign In Error:", error); }
        }
        async function signOutUser() {
            try { await signOut(auth); } catch (error) { console.error("Sign Out Error:", error); }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.id || '';
                const classList = button.classList;
                const idParts = id.split('-');

                if (id === 'add-rack-btn') addRack(button);
                else if (id === 'delete-rack-btn') deleteRack(button);
                else if (id === 'google-signin-btn') signInWithGoogle();
                else if (id === 'signout-btn') signOutUser();
                else if (id.startsWith('nav-')) {
                    currentPage = idParts[1];
                    subPage = (currentPage === 'department') ? 'fattening' : '';
                    renderPageContent();
                } else if (id.startsWith('sub-nav-')) {
                    const page = idParts[2];
                    const newSubPage = idParts[3];
                    if (page === 'department') {
                        subPage = newSubPage;
                        renderDepartmentPage();
                    } else if (page === 'fattening') {
                        fatteningSubPage = newSubPage;
                        renderFatteningContent();
                    }
                } 
                else if (id === 'save-rat-btn') saveRat(button);
                else if (classList.contains('send-rat-quick-btn')) sendQuickRatToOrder(button.dataset.orderId, button.dataset.itemIndex);
                else if (id === 'return-rat-btn') returnRatToCrate(button);
                else if (id === 'open-delete-rat-modal-btn') {
                    if (!currentRack || !currentShelf || !currentSide) {
                        showMessage("กรุณาเลือกตำแหน่งของกระบะก่อน", "warning");
                        return;
                    }
                    document.getElementById('delete-rat-location').textContent = `${currentRack} / ชั้น ${currentShelf} / ${currentSide}`;
                    document.getElementById('delete-rat-modal').classList.remove('hidden');
                }
                else if (id === 'confirm-delete-rat-btn') deleteClosestRat(button);
                else if (id === 'open-add-order-modal') {
                    const modal = document.getElementById('add-order-modal');
                    modal.querySelector('h2').textContent = 'สร้าง Order ใหม่';
                    document.getElementById('save-order-btn').textContent = 'บันทึกและส่งงาน';
                    document.getElementById('save-order-btn').dataset.orderId = '';
                    document.getElementById('add-order-form').reset();
                    document.getElementById('order-items-container').innerHTML = '';
                    addNewOrderItemRow();
                    modal.classList.remove('hidden');
                }
                else if (id === 'add-order-item-btn') addNewOrderItemRow();
                else if (classList.contains('remove-item-btn')) button.closest('.order-item-row').remove();
                else if (id === 'save-order-btn') saveOrder(button);
                else if (classList.contains('close-modal-btn')) button.closest('.modal').classList.add('hidden');
                else if (classList.contains('delete-order-btn')) deleteOrder(button.dataset.orderId);
                else if (classList.contains('edit-order-btn')) editOrder(button.dataset.orderId);
                else if (classList.contains('mark-order-success')) markOrderItemStatus(button.dataset.orderId, button.dataset.itemIndex, 'completed');
                else if (classList.contains('mark-order-fail')) markOrderItemStatus(button.dataset.orderId, button.dataset.itemIndex, 'incomplete');
                else if (classList.contains('size-selector-btn')) {
                    currentSize = button.dataset.size;
                    currentWeight = '';
                    renderFatteningOrderManager();
                } else if (classList.contains('weight-selector-btn')) {
                    if (!godMode && (!currentRack || !currentShelf || !currentSide)) {
                        showMessage("กรุณาเลือกตำแหน่งของกระบะก่อน", "warning");
                        return;
                    }
                    currentWeight = button.dataset.weight;
                    const modal = document.getElementById('action-modal');
                    const info = document.getElementById('action-modal-info');
                    if (info) info.textContent = `ตำแหน่ง: ${godMode ? 'N/A' : `${currentRack}/${currentShelf}/${currentSide}`} | ไซส์: ${currentSize} | น้ำหนัก: ${currentWeight}g`;
                    
                    const sendRatBtn = document.getElementById('send-rat-btn');
                    if (sendRatBtn) sendRatBtn.disabled = !findMatchingOrder();

                    if (modal) modal.classList.remove('hidden');
                } else if (id === 'send-rat-btn') {
                     sendRatToOrder(button);
                } else if (id === 'open-clear-crate-btn') {
                    clearCrate();
                } else if (id === 'confirm-modal-confirm-btn') {
                    const action = button.dataset.action;
                    if (action === 'deleteRack') {
                        confirmDeleteRack(button.dataset.rackCount, button);
                    } else if (action === 'deleteOrder') {
                        confirmDeleteOrder(button.dataset.orderId, button);
                    } else if (action === 'deleteRat') {
                         confirmDeleteRat(button);
                    } else if (action === 'clearCrate') {
                        confirmClearCrate(button);
                    }
                }
            });
            document.body.addEventListener('change', (e) => {
                const target = e.target;
                if (target.id === 'god-mode-checkbox') {
                    godMode = target.checked;
                    localStorage.setItem('godMode', godMode);
                    if (currentPage === 'department' && subPage === 'fattening' && fatteningSubPage === 'order') {
                        renderFatteningOrderManager();
                    }
                }
                else if (['rat-rack', 'rat-shelf', 'rat-side'].includes(target.id)) {
                    currentRack = document.getElementById('rat-rack')?.value || '';
                    currentShelf = document.getElementById('rat-shelf')?.value || '';
                    currentSide = document.getElementById('rat-side')?.value || '';
                    if (currentPage === 'department') {
                        if (fatteningSubPage === 'crate') renderCrateSummary();
                        else if (fatteningSubPage === 'order') renderFatteningOrderManager();
                    }
                } else if (target.name === 'rat-size') {
                    currentSize = target.value; currentWeight = '';
                    if (currentPage === 'department') document.getElementById('rat-form-container').innerHTML = renderRatForm();
                } else if (target.name === 'rat-weight') {
                    currentWeight = target.value;
                } else if (target.classList.contains('role-select')) {
                    updateUserRole(target.dataset.userId, target.value);
                }
            });
        }
        
        // --- UI Rendering ---
        function updateDataDrivenUI() {
            const pageRenderers = {
                'dashboard': renderDashboardPage, 'main': renderMainPage,
                'department': renderDepartmentPage, 'ordertasks': renderOrderTasksPage, 
                'admin': renderAdminPage
            };
            if (pageRenderers[currentPage]) pageRenderers[currentPage]();
            else renderMainPage();
        }

        function renderLoadingUI(message) {
            const container = document.getElementById('page-content');
            if(container) container.innerHTML = `<div class="text-gray-500 flex items-center justify-center p-8"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${message}</div>`;
        }

        function renderError(message) {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `<div class="text-red-500 text-center p-4 bg-red-50 rounded-lg"><h2 class="font-bold text-lg">เกิดข้อผิดพลาด</h2><p class="mt-2">${message}</p></div>`;
        }
        
        function renderLoginUI() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-md mx-auto text-center animate-fade-in">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ระบบจัดการฟาร์มหนู</h1>
                    <p class="text-gray-600 mb-6">กรุณาลงชื่อเข้าใช้เพื่อเริ่มต้น</p>
                    <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full hover:bg-blue-700 transition flex items-center justify-center">
                        <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691c-1.219 2.22-1.994 4.7-1.994 7.309s.775 5.089 1.994 7.309l-5.657 5.657C.654 30.65 0 27.464 0 24s.654-6.65 1.748-9.358z"/><path fill="#4CAF50" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657c-1.746 1.17-3.956 1.849-6.302 1.849-4.207 0-7.837-2.37-9.84-5.698l-5.657 5.657C9.043 43.125 15.93 48 24 48z"/><path fill="#1976D2" d="M43.611 20.083L43.595 20H24v8h11.303a12.042 12.042 0 01-4.087 5.571l5.657 5.657C40.071 35.731 44 30.34 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                        ลงชื่อเข้าใช้ด้วย Google
                    </button>
                </div>`;
        }
        
        function renderAppStructure() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="w-full max-w-5xl mx-auto animate-fade-in">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b">
                         <div class="flex items-center mb-4 sm:mb-0"><img src="${currentUser.photoURL}" alt="User" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">${currentUser.displayName}</p><p class="text-xs text-gray-500 uppercase font-bold">${currentUserRole}</p></div></div>
                         <button id="signout-btn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-600 transition">ออกจากระบบ</button>
                     </div>
                     <div id="nav-container" class="flex space-x-2 mb-6 justify-center flex-wrap gap-2"></div>
                     <div id="page-content" class="min-h-[400px]"></div>
                </div>`;
            document.getElementById('modal-container').innerHTML = renderAddOrderModal() + renderDeleteRatModal() + renderActionModal() + renderConfirmModal();
            renderPageContent();
        }

        function renderPageContent() {
             const pageContent = document.getElementById('page-content');
             const navContainer = document.getElementById('nav-container');
             if (!pageContent || !navContainer) return;

             const navButtons = [
                { id: 'dashboard', label: 'Dashboard', roles: ['admin', 'ceo'] },
                { id: 'main', label: 'หน้าหลัก', roles: ['admin', 'ceo', 'officer', 'fattening_staff', 'user'] },
                { id: 'department', label: 'แผนก', roles: ['admin', 'fattening_staff', 'ceo'] },
                { id: 'ordertasks', label: 'Order / งาน', roles: ['admin', 'officer', 'fattening_staff'] },
                { id: 'admin', label: 'Admin', roles: ['admin'] }
             ];

             navContainer.innerHTML = navButtons
                .filter(btn => btn.roles.includes(currentUserRole))
                .map(btn => `<button id="nav-${btn.id}" class="px-4 py-2 rounded-full font-semibold transition ${currentPage === btn.id ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">${btn.label}</button>`)
                .join('');
             
             renderLoadingUI('กำลังโหลดข้อมูล...');
             updateDataDrivenUI();
        }
        
        // --- PAGE RENDERERS ---
        function renderMainPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            const metrics = calculateDashboardMetrics();
            pageContent.innerHTML = `<div class="animate-fade-in space-y-6">
                <div class="p-6 bg-gray-50 rounded-lg">
                    <h1 class="text-2xl font-bold text-gray-800">ภาพรวมฟาร์ม</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="bg-blue-100 p-4 rounded-lg"><p class="text-blue-800">จำนวนหนูทั้งหมด</p><p class="text-3xl font-bold text-blue-900">${allRats.length} ตัว</p></div>
                        <div class="bg-green-100 p-4 rounded-lg"><p class="text-green-800">ออเดอร์ที่ใช้งาน</p><p class="text-3xl font-bold text-green-900">${allOrders.filter(o => o.items && o.items.some(i => (i.sent || 0) < i.quantity)).length} รายการ</p></div>
                    </div>
                </div>
            </div>`;
        }

        function renderDashboardPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            const metrics = calculateDashboardMetrics();
            pageContent.innerHTML = `<div class="animate-fade-in space-y-6">
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-blue-100 p-4 rounded-lg"><h3 class="text-blue-800 font-bold text-sm">หนูทั้งหมด</h3><p class="text-3xl font-bold text-blue-900">${metrics.totalRats}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><h3 class="text-green-800 font-bold text-sm">Order ที่ใช้งาน</h3><p class="text-3xl font-bold text-green-900">${metrics.activeOrders}</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><h3 class="text-yellow-800 font-bold text-sm">สินค้าที่ต้องส่ง</h3><p class="text-3xl font-bold text-yellow-900">${metrics.totalPendingItems}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-bold mb-2 text-center">จำนวนหนูตามไซส์</h3><canvas id="inventory-chart"></canvas></div>
                    <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-bold mb-2 text-center">สถานะการส่ง Order</h3><canvas id="fulfillment-chart"></canvas></div>
                </div>
            </div>`;
            createBarChart('inventory-chart', ratSizeOptions.map(s => s.size), ratSizeOptions.map(s => metrics.ratCountBySize[s.size] || 0));
            createDoughnutChart('fulfillment-chart', ['ส่งแล้ว', 'ยังไม่ส่ง'], [metrics.totalItemsSent, metrics.totalPendingItems]);
        }
        
        function renderDepartmentPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            const subNav = `<div class="flex space-x-2 mb-6 justify-center">
                <button id="sub-nav-department-fattening" class="px-4 py-2 rounded-full font-semibold ${subPage === 'fattening' ? 'bg-blue-500 text-white' : 'bg-gray-200'}">แผนกขุน</button>
                <button id="sub-nav-department-breeding" class="px-4 py-2 rounded-full font-semibold ${subPage === 'breeding' ? 'bg-blue-500 text-white' : 'bg-gray-200'}">แผนกพ่อแม่พันธุ์</button>
            </div>`;
            pageContent.innerHTML = `<div class="animate-fade-in">${subNav}<div id="sub-page-content"></div></div>`;
            if (subPage === 'breeding') {
                renderBreedingDeptPage();
            } else {
                subPage = 'fattening';
                renderFatteningContent();
            }
        }
        
        function renderFatteningContent() {
            const container = document.getElementById('sub-page-content');
            if (!container) return;
            const fatteningSubNav = `<div class="flex space-x-2 mb-6 justify-center border-b pb-4">
                 <button id="sub-nav-fattening-crate" class="fattening-sub-nav-btn text-sm px-3 py-1 rounded-full font-semibold ${fatteningSubPage === 'crate' ? 'bg-blue-200 text-blue-800' : 'bg-gray-100'}">จัดการกระบะ</button>
                 <button id="sub-nav-fattening-order" class="fattening-sub-nav-btn text-sm px-3 py-1 rounded-full font-semibold ${fatteningSubPage === 'order' ? 'bg-blue-200 text-blue-800' : 'bg-gray-100'}">จัดการ Order</button>
                 <button id="sub-nav-fattening-analytics" class="fattening-sub-nav-btn text-sm px-3 py-1 rounded-full font-semibold ${fatteningSubPage === 'analytics' ? 'bg-blue-200 text-blue-800' : 'bg-gray-100'}">Analytics</button>
            </div>`;
            container.innerHTML = `${fatteningSubNav}<div id="fattening-content-container"></div>`;
            renderFatteningSubContent();
        }
        
        function renderFatteningSubContent() {
             const container = document.getElementById('fattening-content-container');
             if(!container) return;
             if (fatteningSubPage === 'order') {
                renderFatteningOrderManager();
            } else if (fatteningSubPage === 'analytics') {
                renderFatteningAnalytics(container);
            }
            else {
                container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="rat-form-container">${renderRatForm()}</div>
                    <div id="crate-summary-container"></div>
                </div>`;
                renderCrateSummary();
            }
        }

        function renderBreedingDeptPage() {
            const subPageContent = document.getElementById('sub-page-content');
            if(!subPageContent) return;
             subPageContent.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg">
                <h2 class="text-xl font-bold">แผนกพ่อแม่พันธุ์</h2>
                <p class="mt-2 text-gray-600">หน้านี้สำหรับจัดการข้อมูลของแผนกพ่อแม่พันธุ์</p>
            </div>`;
        }

        function renderOrderTasksPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            if (['admin', 'officer'].includes(currentUserRole)) {
                renderOrderTasksForOfficer(pageContent);
            } else if (['fattening_staff'].includes(currentUserRole)) {
                renderOrderTasksForStaff(pageContent, 'fattening');
            } else {
                pageContent.innerHTML = '<p>คุณไม่มีสิทธิ์ดูหน้านี้</p>';
            }
        }

        function renderOrderTasksForOfficer(container) {
            const sortedOrders = [...allOrders].sort((a,b) => {
                const priorityA = a.priority === 'หลัก' ? 0 : 1;
                const priorityB = b.priority === 'หลัก' ? 0 : 1;
                if (priorityA !== priorityB) return priorityA - priorityB;
                return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
            });
            const departmentSections = {
                fattening: { title: 'แผนกขุน', orders: [] },
                breeding: { title: 'แผนกพ่อแม่พันธุ์', orders: [] }
            };
            sortedOrders.forEach(order => {
                if (order.department && departmentSections[order.department]) {
                    departmentSections[order.department].orders.push(order);
                }
            });
            const renderSection = (dept) => {
                if (dept.orders.length === 0) return '';
                const orderListHtml = dept.orders.map(order => {
                    const itemsHtml = (order.items || []).map((item, itemIndex) => { 
                        const sent = item.sent || 0;
                        const quantity = item.quantity;
                        const progress = quantity > 0 ? (sent / quantity) * 100 : 0;
                        const isComplete = sent >= quantity;
                        let statusHtml = '';
                        if (item.status === 'pending' && isComplete) {
                            statusHtml = `<div class="mt-2 flex gap-2"><button class="mark-order-success w-full bg-green-500 text-white py-1 rounded text-sm hover:bg-green-600" data-order-id="${order.id}" data-item-index="${itemIndex}">สำเร็จ</button><button class="mark-order-fail w-full bg-red-500 text-white py-1 rounded text-sm hover:bg-red-600" data-order-id="${order.id}" data-item-index="${itemIndex}">ไม่สำเร็จ</button></div>`;
                        } else if (item.status !== 'pending') {
                            statusHtml = `<p class="mt-2 text-center font-semibold ${item.status === 'completed' ? 'text-green-600' : 'text-red-600'}">ตรวจสอบแล้ว: ${item.status === 'completed' ? 'สำเร็จ' : 'มีปัญหา'}</p>`;
                        }
                        const itemWeightRange = (item.minWeight && item.maxWeight) ? ` (${item.minWeight}-${item.maxWeight}g)` : '';
                        const itemTypeLabel = item.type ? ` (${item.type})` : '';
                        return `<div class="border-t pt-2 mt-2"><div class="flex justify-between"><span>ไซส์ ${item.size}${itemWeightRange}${itemTypeLabel}</span><span class="${isComplete ? 'text-green-600' : 'text-gray-600'}">${sent}/${quantity}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="${isComplete ? 'bg-green-500' : 'bg-blue-500'}" style="width:${progress}%"></div></div>${statusHtml}</div>`;
                    }).join('');
                    return `<div class="bg-white p-4 rounded-lg shadow"><div class="flex justify-between items-start"><h3 class="font-bold text-lg">${order.name} <span class="text-sm font-normal text-gray-500">(${order.priority})</span></h3><div class="flex gap-2"><button class="edit-order-btn text-blue-500 hover:text-blue-700" data-order-id="${order.id}">แก้ไข</button><button class="delete-order-btn text-red-500 hover:text-red-700" data-order-id="${order.id}">ลบ</button></div></div><div class="mt-2">${itemsHtml}</div></div>`;
                }).join('');
                return `<div class="mt-6"><h2 class="text-xl font-bold mb-3">${dept.title}</h2><div class="space-y-4">${orderListHtml}</div></div>`;
            };
            container.innerHTML = `<div class="animate-fade-in space-y-6">
                <div class="flex justify-between items-center"><h1 class="text-2xl font-bold">รายการ Order / งาน</h1><button id="open-add-order-modal" class="bg-blue-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-600">+ เพิ่ม Order</button></div>
                ${renderSection(departmentSections.fattening)}
                ${renderSection(departmentSections.breeding)}
            </div>`;
        }

        function renderOrderTasksForStaff(container, department) {
            let allActiveItems = [];
            allOrders.forEach(order => {
                if (order.department === department) {
                    (order.items || []).forEach((item, index) => {
                        if (item.status === 'pending' && (item.sent || 0) < item.quantity) {
                            allActiveItems.push({ ...item, orderName: order.name, orderId: order.id, itemIndex: index, type: order.type, priority: order.priority });
                        }
                    });
                }
            });
            if (allActiveItems.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-500">ไม่มี Order ที่ต้องจัดส่งในขณะนี้</div>'; return;
            }
            // Sort by priority (หลัก first) and then by creation date
            allActiveItems.sort((a, b) => {
                const priorityA = a.priority === 'หลัก' ? 0 : 1;
                const priorityB = b.priority === 'หลัก' ? 0 : 1;
                if (priorityA !== priorityB) return priorityA - priorityB;
                const orderA = allOrders.find(o => o.id === a.orderId);
                const orderB = allOrders.find(o => o.id === b.orderId);
                return (orderA?.createdAt?.seconds || 0) - (orderB?.createdAt?.seconds || 0);
            });

            const itemsHtml = allActiveItems.map(item => {
                const itemTypeLabel = item.type ? ` (${item.type})` : '';
                const priorityLabel = item.priority ? `(${item.priority})` : '';
                return `<div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between gap-4">
                    <div><p class="font-semibold">ไซส์ ${item.size}${itemTypeLabel}</p><p class="text-sm text-gray-500">${item.orderName} ${priorityLabel}</p></div>
                    <div class="text-right"><p class="font-bold text-lg">${item.sent || 0} / ${item.quantity}</p></div>
                    <button class="send-rat-quick-btn bg-green-500 text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-xl hover:bg-green-600 transition" data-order-id="${item.orderId}" data-item-index="${item.itemIndex}">+1</button>
                </div>`;
            }).join('');
            container.innerHTML = `<div class="animate-fade-in space-y-6">
                <h1 class="text-2xl font-bold">Order ที่ต้องจัดส่ง (แผนกของคุณ)</h1>
                <div class="space-y-3">${itemsHtml}</div>
            </div>`;
        }
        
        function renderActiveOrdersSummary() {
            const container = document.getElementById('active-orders-summary-container');
            if (!container) return;
            const activeOrders = allOrders.filter(o => o.items && o.items.some(i => i.status === 'pending'));
            if (activeOrders.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-500">ไม่มี Order ที่ต้องจัดส่ง</p>';
                return;
            }
            const activeOrdersHtml = activeOrders.map(order => {
                const itemsHtml = (order.items || [])
                    .filter(item => item.status === 'pending')
                    .map(item => {
                         const itemTypeLabel = item.type ? ` (${item.type})` : '';
                         return `<div class="text-sm flex justify-between"><span>- ไซส์ ${item.size}${itemTypeLabel}</span> <span>${item.sent || 0}/${item.quantity}</span></div>`;
                    })
                    .join('');
                return `<div class="bg-white p-3 rounded-lg shadow-sm">
                    <p class="font-bold truncate">${order.name}</p>
                    <div class="mt-1 space-y-1">${itemsHtml}</div>
                </div>`;
            }).join('');
            container.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg">
                 <h2 class="text-xl font-bold mb-4">Order ที่ต้องจัดส่ง</h2>
                 <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2">${activeOrdersHtml}</div>
            </div>`;
        }


        function renderAdminPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            const usersHtml = allUsers.map(user => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div><p class="font-semibold">${user.name}</p><p class="text-sm text-gray-500">${user.email}</p></div>
                    <select data-user-id="${user.id}" class="role-select p-2 border rounded">
                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        <option value="fattening_staff" ${user.role === 'fattening_staff' ? 'selected' : ''}>Fattening Staff</option>
                        <option value="officer" ${user.role === 'officer' ? 'selected' : ''}>Officer</option>
                        <option value="ceo" ${user.role === 'ceo' ? 'selected' : ''}>CEO</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </div>
            `).join('');
             const rackManagementHtml = `
                <div class="bg-gray-50 p-6 rounded-lg shadow-sm mt-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">จัดการ Rack</h2>
                    <p class="mb-2">จำนวน Rack ปัจจุบัน: <span class="font-bold">${farmConfig.rackCount || 6}</span></p>
                    <div class="flex space-x-2">
                        <button id="add-rack-btn" class="bg-green-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-green-600 transition">+ เพิ่ม Rack 1 อัน</button>
                        <button id="delete-rack-btn" class="bg-red-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-red-600 transition">- ลบ RACK 1 อัน</button>
                    </div>
                </div>
            `;
            pageContent.innerHTML = `<div class="animate-fade-in space-y-4">
                <h1 class="text-2xl font-bold">จัดการสิทธิ์ผู้ใช้</h1>
                <div class="space-y-2">${usersHtml}</div>
                ${rackManagementHtml}
            </div>`;
        }

        function renderFatteningAnalytics(container) {
            if (!container) return;
            const totalPopulation = allRats.length + allDeaths.length;
            const mortalityRate = totalPopulation > 0 ? ((allDeaths.length / totalPopulation) * 100).toFixed(2) : 0;

            container.innerHTML = `<div class="animate-fade-in space-y-6">
                <h1 class="text-2xl font-bold">Analytics - แผนกขุน</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-red-50 p-6 rounded-lg shadow">
                        <h2 class="text-red-800 font-bold text-lg">อัตราการตาย</h2>
                        <p class="text-4xl font-bold text-red-600 mt-2">${mortalityRate}%</p>
                        <p class="text-sm text-gray-500 mt-1">จากข้อมูลหนูทั้งหมด ${totalPopulation} ตัว (ตาย ${allDeaths.length} / มีชีวิต ${allRats.length})</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg shadow"><h2 class="text-green-800 font-bold text-lg">รายงานการเจริญเติบโต</h2><p class="text-gray-500 mt-2">เร็วๆ นี้...</p></div>
                </div>
            </div>`;
        }

        // --- UI Components ---
        function renderRatForm() {
            const rackOptions = [...Array(farmConfig.rackCount || 6).keys()].map(i => `<option value="Rack ${i + 1}" ${currentRack === `Rack ${i+1}` ? 'selected':''}>Rack ${i + 1}</option>`).join('');
            const shelfOptions = [...Array(6).keys()].map(i => `<option value="${i + 1}" ${currentShelf == (i+1) ? 'selected':''}>ชั้น ${i + 1}</option>`).join('');
            const sideOptions = ['ซ้าย', 'ขวา'].map(s => `<option value="${s}" ${currentSide === s ? 'selected':''}>${s}</option>`).join('');
            const sizeRadios = ratSizeOptions.map(opt => `<div><input type="radio" id="size-${opt.size}" name="rat-size" value="${opt.size}" class="hidden peer" ${currentSize === opt.size ? 'checked':''}><label for="size-${opt.size}" class="cursor-pointer block p-2 text-center border rounded peer-checked:bg-blue-500 peer-checked:text-white">${opt.size}</label></div>`).join('');
            const weightRadios = () => {
                const size = ratSizeOptions.find(s => s.size === currentSize);
                if (!size) return '';
                return [...Array(size.maxWeight - size.minWeight + 1).keys()].map(i => {
                    const w = size.minWeight + i;
                    return `<div><input type="radio" id="weight-${w}" name="rat-weight" value="${w}" class="hidden peer" ${currentWeight == w ? 'checked':''}><label for="weight-${w}" class="cursor-pointer block p-2 text-center border rounded peer-checked:bg-blue-500 peer-checked:text-white">${w}g</label></div>`;
                }).join('');
            };

            let actionButtonHtml = '';
            if (fatteningSubPage === 'crate') {
                actionButtonHtml = `<div class="space-y-2 pt-2">
                    <button id="save-rat-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition" type="button">+ เพิ่มหนู</button>
                    <button id="open-delete-rat-modal-btn" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition" type="button">ตาย</button>
                    <button id="open-clear-crate-btn" class="w-full bg-gray-600 text-white p-3 rounded-lg font-bold hover:bg-gray-700 transition" type="button">Clear กระบะ</button>
                </div>`;
            } else if (fatteningSubPage === 'order') {
                // This section is now handled by renderFatteningOrderManager
            }

            return `<form class="bg-gray-50 p-4 rounded-lg space-y-4">
                <h2 class="text-xl font-bold">จัดการหนู</h2>
                <div><label class="block mb-1 font-semibold text-gray-700">Rack</label><select id="rat-rack" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${rackOptions}</select></div>
                <div><label class="block mb-1 font-semibold text-gray-700">ชั้น</label><select id="rat-shelf" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${shelfOptions}</select></div>
                <div><label class="block mb-1 font-semibold text-gray-700">กระบะ</label><select id="rat-side" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${sideOptions}</select></div>
                <div><label class="block mb-1 font-semibold text-gray-700">ไซส์</label><div class="grid grid-cols-4 gap-2">${sizeRadios}</div></div>
                <div class="${currentSize ? '' : 'hidden'}"><label class="block mb-1 font-semibold text-gray-700">น้ำหนัก</label><div class="grid grid-cols-5 gap-2">${weightRadios()}</div></div>
                ${actionButtonHtml}
            </form>`;
        }
        function renderFatteningOrderManager() {
            const container = document.getElementById('fattening-content-container');
            if (!container) return;
            const rackOptions = [...Array(farmConfig.rackCount || 6).keys()].map(i => `<option value="Rack ${i + 1}" ${currentRack === `Rack ${i+1}` ? 'selected':''}>Rack ${i + 1}</option>`).join('');
            const shelfOptions = [...Array(6).keys()].map(i => `<option value="${i + 1}" ${currentShelf == (i+1) ? 'selected':''}>ชั้น ${i + 1}</option>`).join('');
            const sideOptions = ['ซ้าย', 'ขวา'].map(s => `<option value="${s}" ${currentSide === s ? 'selected':''}>${s}</option>`).join('');
            const sizeButtonsHtml = ratSizeOptions.map(opt => `<button class="size-selector-btn p-3 border-2 rounded-lg font-semibold ${currentSize === opt.size ? 'bg-blue-500 text-white border-blue-500' : 'bg-white border-gray-300'}" data-size="${opt.size}">${opt.size}</button>`).join('');
            let weightButtonsHtml = '';
            const selectedSizeData = ratSizeOptions.find(s => s.size === currentSize);
            if (selectedSizeData) {
                weightButtonsHtml += `<h3 class="text-lg font-semibold text-gray-700 col-span-full">น้ำหนัก (กรัม)</h3>`;
                for (let i = selectedSizeData.minWeight; i <= selectedSizeData.maxWeight; i++) {
                    weightButtonsHtml += `<button class="weight-selector-btn p-3 border-2 rounded-lg font-semibold bg-white border-gray-300" data-weight="${i}">${i}</button>`;
                }
            }
            container.innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-end items-center gap-2">
                        <span class="font-bold ${godMode ? 'text-red-500' : 'text-gray-600'}">God Mode</span>
                        <label class="god-mode-toggle"><input type="checkbox" id="god-mode-checkbox" ${godMode ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg space-y-4 ${godMode ? 'hidden' : ''}">
                        <h2 class="text-xl font-bold">1. เลือกตำแหน่งกระบะ</h2>
                        <div><label class="block mb-1 font-semibold text-gray-700">Rack</label><select id="rat-rack" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${rackOptions}</select></div>
                        <div><label class="block mb-1 font-semibold text-gray-700">ชั้น</label><select id="rat-shelf" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${shelfOptions}</select></div>
                        <div><label class="block mb-1 font-semibold text-gray-700">กระบะ</label><select id="rat-side" class="w-full p-2 border rounded bg-white"><option value="">เลือก</option>${sideOptions}</select></div>
                        <div id="order-page-summary-container"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                        <h2 class="text-xl font-bold">2. เลือกไซส์และน้ำหนักหนู</h2>
                        <div><h3 class="text-lg font-semibold text-gray-700 mb-2">ไซส์</h3><div class="grid grid-cols-4 gap-2">${sizeButtonsHtml}</div></div>
                        <div id="weight-selection-container" class="grid grid-cols-5 gap-2 mt-4">${weightButtonsHtml}</div>
                    </div>
                </div>`;
            renderCrateSummary();
        }
        function renderCrateSummary() {
            let container;
            if (currentPage === 'department' && fatteningSubPage === 'crate') {
                container = document.getElementById('crate-summary-container');
            } else if (currentPage === 'department' && fatteningSubPage === 'order') {
                container = document.getElementById('order-page-summary-container');
            } else { return; }
            
            if(!container) return;
            if (!currentRack || !currentShelf || !currentSide) {
                container.innerHTML = `<div class="bg-gray-100 p-4 rounded-lg text-center text-gray-500">โปรดเลือกตำแหน่งเพื่อดูสรุป</div>`; return;
            }
            const filteredRats = allRats.filter(r => r.rack === currentRack && r.shelf == currentShelf && r.side === currentSide);
            const count = filteredRats.length;
            container.innerHTML = `<div class="bg-gray-100 p-4 rounded-lg space-y-2">
                <h3 class="font-bold text-xl">สรุปกระบะ</h3>
                <p class="text-lg">${currentRack} / ชั้น ${currentShelf} / ${currentSide}</p>
                <p class="text-4xl font-bold">${count} <span class="text-xl font-normal">ตัว</span></p>
            </div>`;
        }
        function renderAddOrderModal() {
            return `<div id="add-order-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fade-in">
                    <h2 class="text-2xl font-bold mb-4">สร้าง Order ใหม่</h2>
                    <form id="add-order-form" class="space-y-4">
                        <input type="hidden" id="edit-order-id">
                        <div><label for="order-name-input" class="block mb-1">ชื่อ Order</label><input type="text" id="order-name-input" class="w-full p-2 border rounded" value="Order ${new Date().toLocaleDateString('th-TH')}"></div>
                        <div>
                            <label for="department-select" class="block mb-1">ส่งให้แผนก</label>
                            <select id="department-select" class="w-full p-2 border rounded bg-white">
                                <option value="">-- เลือกแผนก --</option>
                                <option value="fattening">แผนกขุน</option>
                                <option value="breeding">แผนกพ่อแม่พันธุ์</option>
                            </select>
                        </div>
                        <div>
                            <label for="order-priority-select" class="block mb-1">ลำดับความสำคัญ</label>
                            <select id="order-priority-select" class="w-full p-2 border rounded bg-white">
                                <option value="หลัก">หลัก</option>
                                <option value="รอง">รอง</option>
                            </select>
                        </div>
                        <div id="order-items-container" class="space-y-2 max-h-60 overflow-y-auto p-1"></div>
                        <button type="button" id="add-order-item-btn" class="w-full p-2 bg-gray-200 rounded hover:bg-gray-300">+ เพิ่มรายการ</button>
                    </form>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" class="close-modal-btn p-2 bg-gray-100 rounded">ยกเลิก</button>
                        <button id="save-order-btn" class="p-2 bg-blue-500 text-white rounded">บันทึกและส่งงาน</button>
                    </div>
                </div>
            </div>`;
        }
        function renderDeleteRatModal() {
            return `<div id="delete-rat-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fade-in">
                    <h2 class="text-2xl font-bold mb-4">ลบหนู (ตาย)</h2>
                    <p class="text-gray-600 mb-4">กรุณาเลือกตำแหน่งและระบุน้ำหนักโดยประมาณของหนูที่ตายเพื่อลบออกจากระบบ</p>
                    <form id="delete-rat-form" class="space-y-4">
                        <div>
                            <label class="block mb-1 font-semibold text-gray-700">ตำแหน่ง</label>
                            <p id="delete-rat-location" class="p-2 bg-gray-100 rounded"></p>
                        </div>
                        <div>
                            <label for="delete-rat-weight-input" class="block mb-1 font-semibold text-gray-700">น้ำหนักโดยประมาณ (กรัม)</label>
                            <input type="number" id="delete-rat-weight-input" class="w-full p-2 border rounded" placeholder="เช่น 25" min="1">
                        </div>
                    </form>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" class="close-modal-btn p-2 bg-gray-100 rounded">ยกเลิก</button>
                        <button id="confirm-delete-rat-btn" class="p-2 bg-red-500 text-white rounded">ยืนยันการลบ</button>
                    </div>
                </div>
            </div>`;
        }
        function renderActionModal() {
            const hasMatchingOrder = findMatchingOrder();
            return `<div id="action-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-lg p-6 w-full max-w-sm animate-fade-in text-center space-y-4">
                    <h2 class="text-2xl font-bold mb-4">เลือกการกระทำ</h2>
                    <p id="action-modal-info" class="text-gray-600 mb-4"></p>
                    <div class="space-y-3">
                        <button id="send-rat-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition" type="button" ${!hasMatchingOrder ? 'disabled' : ''}>ส่งหนูตาม Order</button>
                        ${!godMode ? `<button id="return-rat-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" type="button">ส่งคืนเข้ากระบะ (อัปเดตน้ำหนัก)</button>` : ''}
                    </div>
                     <div class="pt-4"><button type="button" class="close-modal-btn p-2 text-gray-500 hover:text-gray-800">ยกเลิก</button></div>
                </div>
            </div>`;
        }
        
        function renderConfirmModal() {
            return `<div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fade-in">
                    <h2 class="text-2xl font-bold mb-4">ยืนยันการกระทำ</h2>
                    <p id="confirm-modal-message" class="text-gray-600 mb-4"></p>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" class="close-modal-btn p-2 bg-gray-100 rounded">ยกเลิก</button>
                        <button id="confirm-modal-confirm-btn" class="p-2 bg-red-500 text-white rounded">ยืนยัน</button>
                    </div>
                </div>
            </div>`;
        }
        
        function showMessage(message, type) {
            const container = document.getElementById('message-box');
            if(!container) return;
            const messageElement = document.createElement('div');
            let colorClass = '';
            if (type === 'success') colorClass = 'bg-green-500';
            else if (type === 'error') colorClass = 'bg-red-500';
            else if (type === 'warning') colorClass = 'bg-yellow-500';
            else colorClass = 'bg-gray-500';
            
            messageElement.className = `${colorClass} text-white p-4 mb-2 rounded-lg shadow-lg animate-fade-in`;
            messageElement.textContent = message;
            container.appendChild(messageElement);
            setTimeout(() => {
                messageElement.classList.add('hidden');
                setTimeout(() => messageElement.remove(), 300);
            }, 3000);
        }

        function addNewOrderItemRow(item = null) {
            const container = document.getElementById('order-items-container');
            const row = document.createElement('div');
            row.className = 'order-item-row flex flex-col md:flex-row items-center gap-2 animate-fade-in border p-2 rounded';
            
            const sizeOptions = ratSizeOptions.map(s => `<option value="${s.size}" ${item && item.size === s.size ? 'selected' : ''}>${s.size}</option>`).join('');
            const typeOptions = `<option value="หนูเป็น" ${item && item.type === 'หนูเป็น' ? 'selected' : ''}>หนูเป็น</option><option value="หนูแช่" ${item && item.type === 'หนูแช่' ? 'selected' : ''}>หนูแช่</option>`;
            
            const quantityValue = item ? item.quantity : 1;
            const minWeightValue = item ? item.minWeight : ratSizeOptions[0].minWeight;
            const maxWeightValue = item ? item.maxWeight : ratSizeOptions[0].maxWeight;

            row.innerHTML = `
                <div class="flex-1 w-full"><label class="text-sm text-gray-500">ชนิด</label><select class="item-type-select w-full p-2 border rounded">${typeOptions}</select></div>
                <div class="flex-1 w-full"><label class="text-sm text-gray-500">ไซส์</label><select class="size-select w-full p-2 border rounded">${sizeOptions}</select></div>
                <div class="flex-1 w-full"><label class="text-sm text-gray-500">จำนวน</label><input type="number" class="quantity-input w-full p-2 border rounded" placeholder="จำนวน" min="1" value="${quantityValue}"></div>
                <div class="flex-1 w-full"><label class="text-sm text-gray-500">น้ำหนักต่ำสุด</label><input type="number" class="min-weight-input w-full p-2 border rounded" placeholder="กรัม" min="1" value="${minWeightValue}"></div>
                <div class="flex-1 w-full"><label class="text-sm text-gray-500">น้ำหนักสูงสุด</label><input type="number" class="max-weight-input w-full p-2 border rounded" placeholder="กรัม" min="1" value="${maxWeightValue}"></div>
                <button type="button" class="remove-item-btn text-red-500 font-bold p-2">X</button>
            `;
            container.appendChild(row);

            const sizeSelect = row.querySelector('.size-select');
            const minWeightInput = row.querySelector('.min-weight-input');
            const maxWeightInput = row.querySelector('.max-weight-input');

            // Update min/max weight when size changes
            sizeSelect.addEventListener('change', (e) => {
                const selectedSizeData = ratSizeOptions.find(s => s.size === e.target.value);
                if (selectedSizeData) {
                    minWeightInput.value = selectedSizeData.minWeight;
                    maxWeightInput.value = selectedSizeData.maxWeight;
                }
            });
        }

        // --- Chart & Metric Helpers ---
        function calculateDashboardMetrics() {
            const totalRats = allRats.length;
            const activeOrders = allOrders.filter(o => o.items && o.items.some(i => (i.sent || 0) < i.quantity)).length;
            let totalPendingItems = 0, totalItemsSent = 0;
            allOrders.forEach(order => {
                (order.items || []).forEach(item => {
                    totalItemsSent += (item.sent || 0);
                    totalPendingItems += Math.max(0, (item.quantity || 0) - (item.sent || 0));
                });
            });
            const ratCountBySize = allRats.reduce((acc, rat) => {
                acc[rat.size] = (acc[rat.size] || 0) + 1;
                return acc;
            }, {});
            return { totalRats, activeOrders, totalPendingItems, totalItemsSent, ratCountBySize };
        }
        function createBarChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ data, backgroundColor: 'rgba(59, 130, 246, 0.5)' }] }, options: { responsive: true, plugins: { legend: { display: false } } } });
        }
        function createDoughnutChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'] }] }, options: { responsive: true } });
        }

        // --- New function to find a matching order ---
        function findMatchingOrder() {
            if (!currentSize || !currentWeight) return false;
            
            const currentRatWeight = parseFloat(currentWeight);
            const selectedSizeData = ratSizeOptions.find(s => s.size === currentSize);
            if (!selectedSizeData) return false;
            const currentRatOrder = selectedSizeData.order;
            const ratType = 'หนูเป็น'; // Hardcoded assumption for this flow
            
            // Filter orders for 'fattening' department
            const relevantOrders = allOrders.filter(o => o.department === 'fattening');
            
            // Check for Primary Order
            const primaryOrderFound = relevantOrders.some(o => 
                o.priority === 'หลัก' && o.items.some(item => 
                    item.size === currentSize && item.type === ratType && item.status === 'pending' && currentRatWeight >= item.minWeight && currentRatWeight <= item.maxWeight
                )
            );
            if (primaryOrderFound) return true;

            // Check for Secondary Order
            const secondaryOrderFound = relevantOrders.some(o => o.priority === 'รอง' && o.items.some(item => {
                 const targetItemSizeData = ratSizeOptions.find(s => s.size === item.size);
                 if (!targetItemSizeData) return false;

                 if (ratType === 'หนูเป็น') {
                     // Live rats can be sent to larger size orders
                     if (targetItemSizeData.order > currentRatOrder) {
                         return item.type === ratType && item.status === 'pending' && currentRatWeight >= item.minWeight && currentRatWeight <= item.maxWeight;
                     }
                 } else { // Frozen rat logic
                     // Frozen rats can be sent to smaller size orders
                     if (targetItemSizeData.order < currentRatOrder) {
                         return item.type === ratType && item.status === 'pending' && currentRatWeight >= item.minWeight && currentRatWeight <= item.maxWeight;
                     }
                 }
                return false;
            }));
            
            return secondaryOrderFound;
        }
        
    </script>
</body>
</html>
