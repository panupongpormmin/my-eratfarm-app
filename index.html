<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มหนู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">
    <div id="app-container" class="container mx-auto p-4 bg-white rounded-2xl shadow-2xl min-h-[90vh] flex flex-col items-center justify-center">
        <!-- สถานะโหลดเริ่มต้น -->
        <div class="text-gray-500 flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            กำลังเริ่มต้น...
        </div>
    </div>
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, getDocs, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App ID ---
        const appId = 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAkCMLbcWCT9jhkRVU2bhVMjdWaeuMm1vo",
            authDomain: "eratfarm-bd035.firebaseapp.com",
            projectId: "eratfarm-bd035",
            storageBucket: "eratfarm-bd035.appspot.com",
            messagingSenderId: "462976136580",
            appId: "1:462976136580:web:a1ef8ee2b32f1cc4bf19d1",
            measurementId: "G-QHBHS05KRL"
        };
        
        // --- App State ---
        let app, db, auth;
        let currentUser = null, currentUserRole = null;
        let allRats = [], allOrders = [], allUsers = [];
        let currentPage = 'main';
        let subPage = '';
        let currentRack = '', currentShelf = '', currentSide = '', currentSize = '', currentWeight = '';
        let chartInstances = {};
        let unsubscribeListeners = [];
        const ratSizeOptions = [
            { size: "JUMP", minWeight: 9, maxWeight: 13 }, { size: "S", minWeight: 14, maxWeight: 18 },
            { size: "M", minWeight: 19, maxWeight: 23 }, { size: "L", minWeight: 24, maxWeight: 28 },
            { size: "XL", minWeight: 29, maxWeight: 33 }, { size: "XXL", minWeight: 34, maxWeight: 38 },
            { size: "XXL+", minWeight: 39, maxWeight: 45 }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    clearAllListeners();
                    if (user) {
                        currentUser = user;
                        await checkUserRole(user);
                        renderAppStructure();
                        attachDataListeners();
                    } else {
                        resetAppState();
                        renderLoginUI();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                renderError("การเริ่มต้น Firebase ล้มเหลว: " + error.message);
            }
        }

        // --- Data Management ---
        function attachDataListeners() {
            const paths = {
                rats: `artifacts/${appId}/public/data/rats`,
                orders: `artifacts/${appId}/public/data/orders`,
                users: `artifacts/${appId}/public/data/user_roles`,
            };

            unsubscribeListeners.push(onSnapshot(collection(db, paths.rats), 
                (snapshot) => { allRats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateDataDrivenUI(); },
                (err) => { console.error("Rats Listener Error:", err); renderError("ไม่สามารถโหลดข้อมูลหนูได้"); })
            );
            unsubscribeListeners.push(onSnapshot(collection(db, paths.orders),
                (snapshot) => { allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateDataDrivenUI(); },
                (err) => { console.error("Orders Listener Error:", err); renderError("ไม่สามารถโหลดข้อมูลออเดอร์ได้"); })
            );
            if (currentUserRole === 'admin') {
                 unsubscribeListeners.push(onSnapshot(collection(db, paths.users),
                    (snapshot) => { allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateDataDrivenUI(); },
                    (err) => { console.error("Users Listener Error:", err); renderError("ไม่สามารถโหลดข้อมูลผู้ใช้ได้"); })
                );
            }
        }

        function clearAllListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        }

        function resetAppState() {
            currentUser = null; currentUserRole = null;
            allRats = []; allOrders = []; allUsers = [];
            currentPage = 'main';
            subPage = '';
            currentRack = ''; currentShelf = ''; currentSide = ''; currentSize = ''; currentWeight = '';
        }

        async function checkUserRole(user) {
            const userRoleRef = doc(db, `artifacts/${appId}/public/data/user_roles`, user.uid);
            try {
                const docSnap = await getDoc(userRoleRef);
                if (docSnap.exists()) {
                    currentUserRole = docSnap.data().role;
                } else {
                    const rolesQuery = query(collection(db, `artifacts/${appId}/public/data/user_roles`));
                    const rolesSnapshot = await getDocs(rolesQuery);
                    const newRole = rolesSnapshot.empty ? 'admin' : 'user';
                    await setDoc(userRoleRef, { role: newRole, email: user.email, name: user.displayName });
                    currentUserRole = newRole;
                }
                if ((['admin', 'ceo'].includes(currentUserRole)) && currentPage === 'main') {
                    currentPage = 'dashboard';
                }
            } catch (error) {
                console.error("Check Role Error:", error);
                renderError("ไม่สามารถตรวจสอบสิทธิ์ผู้ใช้ได้: " + error.message + "<br>กรุณาตรวจสอบ Firestore Security Rules");
            }
        }
        
        // --- Logic Functions ---
        async function saveRat(button) {
            if (!currentRack || !currentShelf || !currentSide || !currentSize || !currentWeight) {
                return alert("กรุณากรอกข้อมูลให้ครบถ้วน");
            }
            button.disabled = true;
            const ratData = {
                rack: currentRack, shelf: currentShelf, side: currentSide,
                size: currentSize, weight: parseFloat(currentWeight),
                createdAt: new Date().toISOString()
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/rats`), ratData);
            } catch(e) { console.error(e); } finally { button.disabled = false; }
        }

        async function saveOrder(button) {
             button.disabled = true;
             const orderName = document.getElementById('order-name-input').value || 'New Order';
             const items = [];
             document.querySelectorAll('#order-items-container .order-item-row').forEach(row => {
                 const size = row.querySelector('.size-select').value;
                 const quantity = parseInt(row.querySelector('.quantity-input').value, 10);
                 if (size && quantity > 0) {
                     items.push({ size, quantity, sent: 0 });
                 }
             });
             if (items.length > 0) {
                 try {
                     await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), { name: orderName, items, createdAt: new Date().toISOString() });
                     document.getElementById('add-order-modal').classList.add('hidden');
                 } catch (e) { console.error(e); }
             }
             button.disabled = false;
        }

        async function deleteOrder(orderId) {
            if(confirm('คุณต้องการลบ Order นี้ใช่หรือไม่?')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId));
                } catch(e) { console.error(e); }
            }
        }

        async function updateUserRole(userId, newRole) {
             try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/user_roles`, userId), { role: newRole });
             } catch(e) { console.error(e); }
        }

        // --- Authentication ---
        async function signInWithGoogle() { /* ... unchanged ... */ }
        async function signOutUser() { /* ... unchanged ... */ }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.id || '';

                if (id === 'google-signin-btn') signInWithGoogle();
                else if (id === 'signout-btn') signOutUser();
                else if (id.startsWith('nav-')) {
                    currentPage = id.split('-')[1]; subPage = ''; renderPageContent();
                } else if (id.startsWith('sub-nav-')) {
                    subPage = id.split('-')[2]; renderManagePage();
                } else if (id === 'save-rat-btn') saveRat(button);
                else if (id === 'open-add-order-modal') document.getElementById('add-order-modal').classList.remove('hidden');
                else if (id === 'add-order-item-btn') addNewOrderItemRow();
                else if (button.classList.contains('remove-item-btn')) button.closest('.order-item-row').remove();
                else if (id === 'save-order-btn') saveOrder(button);
                else if (button.classList.contains('close-modal-btn')) button.closest('.modal').classList.add('hidden');
                else if (button.classList.contains('delete-order-btn')) deleteOrder(button.dataset.orderId);
            });
            document.body.addEventListener('change', (e) => {
                const target = e.target;
                if (['rat-rack', 'rat-shelf', 'rat-side'].includes(target.id)) {
                    currentRack = document.getElementById('rat-rack')?.value || '';
                    currentShelf = document.getElementById('rat-shelf')?.value || '';
                    currentSide = document.getElementById('rat-side')?.value || '';
                    if (currentPage === 'manage') renderCrateSummary();
                } else if (target.name === 'rat-size') {
                    currentSize = target.value; currentWeight = '';
                    if (currentPage === 'manage') document.getElementById('rat-form-container').innerHTML = renderRatForm();
                } else if (target.name === 'rat-weight') {
                    currentWeight = target.value;
                } else if (target.classList.contains('role-select')) {
                    updateUserRole(target.dataset.userId, target.value);
                }
            });
        }
        
        // --- UI Rendering ---
        function updateDataDrivenUI() {
            const pageRenderers = {
                'dashboard': renderDashboardPage, 'main': renderMainPage,
                'manage': renderManagePage, 'order': renderOrderPage, 'admin': renderAdminPage
            };
            if (pageRenderers[currentPage]) pageRenderers[currentPage]();
            else renderMainPage();
        }

        function renderLoadingUI(message) {
            const container = document.getElementById('page-content');
            if(container) container.innerHTML = `<div class="text-gray-500 flex items-center justify-center p-8"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${message}</div>`;
        }

        function renderError(message) { /* ... unchanged ... */ }
        function renderLoginUI() { /* ... unchanged ... */ }
        
        function renderAppStructure() {
            const container = document.getElementById('app-container');
            if(container) container.innerHTML = `
                <div class="w-full max-w-5xl mx-auto animate-fade-in">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b">
                         <div class="flex items-center mb-4 sm:mb-0"><img src="${currentUser.photoURL}" alt="User" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">${currentUser.displayName}</p><p class="text-xs text-gray-500 uppercase font-bold">${currentUserRole}</p></div></div>
                         <button id="signout-btn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-600 transition">ออกจากระบบ</button>
                     </div>
                     <div id="nav-container" class="flex space-x-2 mb-6 justify-center flex-wrap gap-2"></div>
                     <div id="page-content" class="min-h-[400px]"></div>
                </div>`;
            document.getElementById('modal-container').innerHTML = renderAddOrderModal();
            renderPageContent();
        }

        function renderPageContent() {
             const pageContent = document.getElementById('page-content');
             const navContainer = document.getElementById('nav-container');
             if (!pageContent || !navContainer) return;

             const navButtons = [
                { id: 'dashboard', label: 'Dashboard', roles: ['admin', 'ceo'] },
                { id: 'main', label: 'หน้าหลัก', roles: ['admin', 'ceo', 'officer', 'fattening_staff', 'user'] },
                { id: 'manage', label: 'แผนกขุน', roles: ['admin', 'fattening_staff'] },
                { id: 'order', label: 'Order', roles: ['admin', 'officer'] },
                { id: 'admin', label: 'Admin', roles: ['admin'] }
             ];

             navContainer.innerHTML = navButtons
                .filter(btn => btn.roles.includes(currentUserRole))
                .map(btn => `<button id="nav-${btn.id}" class="px-4 py-2 rounded-full font-semibold transition ${currentPage === btn.id ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">${btn.label}</button>`)
                .join('');
             
             renderLoadingUI('กำลังโหลดข้อมูล...');
             updateDataDrivenUI();
        }
        
        function renderMainPage() { /* ... unchanged ... */ }
        
        function renderDashboardPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            
            const metrics = calculateDashboardMetrics();
            pageContent.innerHTML = `<div class="animate-fade-in space-y-6">
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-blue-100 p-4 rounded-lg"><h3 class="text-blue-800 font-bold text-sm">หนูทั้งหมด</h3><p class="text-3xl font-bold text-blue-900">${metrics.totalRats}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><h3 class="text-green-800 font-bold text-sm">Order ที่ใช้งาน</h3><p class="text-3xl font-bold text-green-900">${metrics.activeOrders}</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><h3 class="text-yellow-800 font-bold text-sm">สินค้าที่ต้องส่ง</h3><p class="text-3xl font-bold text-yellow-900">${metrics.totalPendingItems}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-bold mb-2 text-center">จำนวนหนูตามไซส์</h3><canvas id="inventory-chart"></canvas></div>
                    <div class="bg-white p-4 rounded-lg shadow"><h3 class="font-bold mb-2 text-center">สถานะการส่ง Order</h3><canvas id="fulfillment-chart"></canvas></div>
                </div>
            </div>`;

            createBarChart('inventory-chart', ratSizeOptions.map(s => s.size), ratSizeOptions.map(s => metrics.ratCountBySize[s.size] || 0));
            createDoughnutChart('fulfillment-chart', ['ส่งแล้ว', 'ยังไม่ส่ง'], [metrics.totalItemsSent, metrics.totalPendingItems]);
        }
        
        function renderManagePage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            const subNav = `<div class="flex space-x-2 mb-6 justify-center">
                <button id="sub-nav-crate" class="px-4 py-2 rounded-full font-semibold ${!subPage || subPage === 'crate' ? 'bg-blue-500 text-white' : 'bg-gray-200'}">จัดการกระบะ</button>
            </div>`;
            pageContent.innerHTML = `<div class="animate-fade-in">${subNav}<div id="sub-page-content"></div></div>`;
            renderCrateManagementPage();
        }

        function renderCrateManagementPage() {
            const subPageContent = document.getElementById('sub-page-content');
            if (!subPageContent) return;
            subPageContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="rat-form-container">${renderRatForm()}</div>
                <div id="crate-summary-container"></div>
            </div>`;
            renderCrateSummary();
        }

        function renderOrderPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            const sortedOrders = [...allOrders].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            const orderListHtml = sortedOrders.map(order => {
                const itemsHtml = order.items.map(item => {
                    const progress = item.quantity > 0 ? (item.sent / item.quantity) * 100 : 0;
                    const isComplete = item.sent >= item.quantity;
                    return `<div class="border-t pt-2 mt-2"><div class="flex justify-between"><span>ไซส์ ${item.size}</span><span class="${isComplete ? 'text-green-600' : 'text-gray-600'}">${item.sent}/${item.quantity}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="${isComplete ? 'bg-green-500' : 'bg-blue-500'}" style="width:${progress}%"></div></div></div>`;
                }).join('');
                return `<div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg">${order.name}</h3>
                        ${currentUserRole === 'admin' ? `<button class="delete-order-btn text-red-500" data-order-id="${order.id}">ลบ</button>` : ''}
                    </div>
                    <div class="mt-2">${itemsHtml}</div>
                </div>`;
            }).join('') || '<p class="text-center text-gray-500">ยังไม่มี Order</p>';
            
            pageContent.innerHTML = `<div class="animate-fade-in space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">รายการ Order</h1>
                    ${currentUserRole === 'admin' ? '<button id="open-add-order-modal" class="bg-blue-500 text-white px-4 py-2 rounded-full font-semibold">+ เพิ่ม Order</button>' : ''}
                </div>
                <div class="space-y-4">${orderListHtml}</div>
            </div>`;
        }

        function renderAdminPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;
            const usersHtml = allUsers.map(user => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div><p class="font-semibold">${user.name}</p><p class="text-sm text-gray-500">${user.email}</p></div>
                    <select data-user-id="${user.id}" class="role-select p-2 border rounded">
                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        <option value="fattening_staff" ${user.role === 'fattening_staff' ? 'selected' : ''}>Fattening Staff</option>
                        <option value="officer" ${user.role === 'officer' ? 'selected' : ''}>Officer</option>
                        <option value="ceo" ${user.role === 'ceo' ? 'selected' : ''}>CEO</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </div>
            `).join('');
            pageContent.innerHTML = `<div class="animate-fade-in space-y-4">
                <h1 class="text-2xl font-bold">จัดการสิทธิ์ผู้ใช้</h1>
                <div class="space-y-2">${usersHtml}</div>
            </div>`;
        }

        // --- UI Components ---
        function renderRatForm() {
            const rackOptions = [...Array(6).keys()].map(i => `<option value="Rack ${i + 1}" ${currentRack === `Rack ${i+1}` ? 'selected':''}>Rack ${i + 1}</option>`).join('');
            const shelfOptions = [...Array(6).keys()].map(i => `<option value="${i + 1}" ${currentShelf == (i+1) ? 'selected':''}>ชั้น ${i + 1}</option>`).join('');
            const sideOptions = ['ซ้าย', 'ขวา'].map(s => `<option value="${s}" ${currentSide === s ? 'selected':''}>${s}</option>`).join('');
            const sizeRadios = ratSizeOptions.map(opt => `<div><input type="radio" id="size-${opt.size}" name="rat-size" value="${opt.size}" class="hidden peer" ${currentSize === opt.size ? 'checked':''}><label for="size-${opt.size}" class="cursor-pointer block p-2 text-center border rounded peer-checked:bg-blue-500 peer-checked:text-white">${opt.size}</label></div>`).join('');
            const weightRadios = () => {
                const size = ratSizeOptions.find(s => s.size === currentSize);
                if (!size) return '';
                return [...Array(size.maxWeight - size.minWeight + 1).keys()].map(i => {
                    const w = size.minWeight + i;
                    return `<div><input type="radio" id="weight-${w}" name="rat-weight" value="${w}" class="hidden peer" ${currentWeight == w ? 'checked':''}><label for="weight-${w}" class="cursor-pointer block p-2 text-center border rounded peer-checked:bg-blue-500 peer-checked:text-white">${w}g</label></div>`;
                }).join('');
            };

            return `<form class="bg-gray-50 p-4 rounded-lg space-y-4">
                <h2 class="text-xl font-bold">จัดการหนู</h2>
                <div><label class="block mb-1">Rack</label><select id="rat-rack" class="w-full p-2 border rounded"><option value="">เลือก</option>${rackOptions}</select></div>
                <div><label class="block mb-1">ชั้น</label><select id="rat-shelf" class="w-full p-2 border rounded"><option value="">เลือก</option>${shelfOptions}</select></div>
                <div><label class="block mb-1">กระบะ</label><select id="rat-side" class="w-full p-2 border rounded"><option value="">เลือก</option>${sideOptions}</select></div>
                <div><label class="block mb-1">ไซส์</label><div class="grid grid-cols-4 gap-2">${sizeRadios}</div></div>
                <div class="${currentSize ? '' : 'hidden'}"><label class="block mb-1">น้ำหนัก</label><div class="grid grid-cols-5 gap-2">${weightRadios()}</div></div>
                <button id="save-rat-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition" type="button">+ เพิ่มหนู</button>
            </form>`;
        }

        function renderCrateSummary() {
            const container = document.getElementById('crate-summary-container');
            if(!container) return;
            if (!currentRack || !currentShelf || !currentSide) {
                container.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg text-center text-gray-500">โปรดเลือกตำแหน่งเพื่อดูสรุป</div>`; return;
            }
            const filteredRats = allRats.filter(r => r.rack === currentRack && r.shelf == currentShelf && r.side === currentSide);
            const count = filteredRats.length;
            container.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg space-y-2">
                <h3 class="font-bold">สรุปกระบะ: ${currentRack} / ${currentShelf} / ${currentSide}</h3>
                <p>จำนวนหนู: <span class="font-bold text-xl">${count}</span> ตัว</p>
            </div>`;
        }
        
        function renderAddOrderModal() {
            return `<div id="add-order-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fade-in">
                    <h2 class="text-2xl font-bold mb-4">สร้าง Order ใหม่</h2>
                    <form id="add-order-form" class="space-y-4">
                        <div><label for="order-name-input" class="block mb-1">ชื่อ Order</label><input type="text" id="order-name-input" class="w-full p-2 border rounded" value="Order ${new Date().toLocaleDateString('th-TH')}"></div>
                        <div id="order-items-container" class="space-y-2 max-h-60 overflow-y-auto p-1"></div>
                        <button type="button" id="add-order-item-btn" class="w-full p-2 bg-gray-200 rounded hover:bg-gray-300">+ เพิ่มรายการ</button>
                    </form>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button class="close-modal-btn p-2 bg-gray-100 rounded">ยกเลิก</button>
                        <button id="save-order-btn" class="p-2 bg-blue-500 text-white rounded">บันทึก</button>
                    </div>
                </div>
            </div>`;
        }

        function addNewOrderItemRow() {
            const container = document.getElementById('order-items-container');
            const row = document.createElement('div');
            row.className = 'order-item-row flex items-center gap-2';
            const sizeOptions = ratSizeOptions.map(s => `<option value="${s.size}">${s.size}</option>`).join('');
            row.innerHTML = `
                <select class="size-select w-1/2 p-2 border rounded">${sizeOptions}</select>
                <input type="number" class="quantity-input w-1/2 p-2 border rounded" placeholder="จำนวน" min="1" value="1">
                <button type="button" class="remove-item-btn text-red-500">X</button>
            `;
            container.appendChild(row);
        }

        // --- Chart & Metric Helpers ---
        function calculateDashboardMetrics() {
            const totalRats = allRats.length;
            const activeOrders = allOrders.filter(o => o.items && o.items.some(i => i.sent < i.quantity)).length;
            let totalPendingItems = 0, totalItemsSent = 0;
            allOrders.forEach(order => {
                order.items?.forEach(item => {
                    totalItemsSent += (item.sent || 0);
                    totalPendingItems += Math.max(0, (item.quantity || 0) - (item.sent || 0));
                });
            });
            const ratCountBySize = allRats.reduce((acc, rat) => {
                acc[rat.size] = (acc[rat.size] || 0) + 1;
                return acc;
            }, {});
            return { totalRats, activeOrders, totalPendingItems, totalItemsSent, ratCountBySize };
        }

        function createBarChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ data, backgroundColor: 'rgba(59, 130, 246, 0.5)' }] }, options: { responsive: true, plugins: { legend: { display: false } } } });
        }

        function createDoughnutChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'] }] }, options: { responsive: true } });
        }
        
    </script>
</body>
</html>

